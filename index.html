<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Project Document System</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #1a1d21; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); text-transform: uppercase; margin-bottom: 25px; }
        
        .toolbar { margin-bottom: 10px; display: flex; gap: 10px; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; background: #fff; }

        .template-list { border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; max-height: 150px; overflow-y: auto; margin-bottom: 20px; background: #fff; }
        .tpl-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f8f9fa; cursor: pointer; }
        
        .main-layout { display: flex; gap: 25px; margin-top: 20px; flex-wrap: wrap; }
        .input-section { flex: 1.2; min-width: 350px; }
        .preview-section { flex: 0.8; min-width: 300px; background: var(--dark); color: #fff; padding: 20px; border-radius: 10px; height: fit-content; position: sticky; top: 20px; }
        
        .field-box { background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #dee2e6; border-left: 5px solid var(--primary); }
        .field-box.empty { border-left-color: var(--danger); background: #fff5f5; }
        
        .label { font-weight: bold; font-size: 0.85rem; color: #495057; display: block; margin-bottom: 6px; }
        .input-tag { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        textarea.input-tag { resize: vertical; min-height: 60px; }

        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 1rem; margin-top: 10px; }
        .bg-scan { background: var(--success); }
        .bg-zip { background: var(--danger); display: none; }
        
        #status { text-align: center; margin: 15px; font-weight: bold; color: var(--primary); }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 0.85rem; color: #00ff00; }
        #qrcode { background: white; padding: 10px; margin-top: 15px; display: inline-block; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìÑ Global Project Document System</h2>
    
    <div class="toolbar">
        <button class="btn-small" onclick="toggleAll(true)">‚úÖ Select All</button>
        <button class="btn-small" onclick="toggleAll(false)">‚ùå Deselect</button>
    </div>
    <div id="templateList" class="template-list">Loading templates from JSON...</div>
    
    <button class="btn-main bg-scan" onclick="scanAll()">üîç ANALYZE SELECTED TEMPLATES</button>
    <div id="status"></div>

    <div class="main-layout" id="formArea" style="display: none;">
        <div class="input-section">
            <div id="fields"></div>
        </div>
        <div class="preview-section">
            <span style="color: #ffc107; font-weight: bold;">LIVE DATA PREVIEW</span>
            <hr>
            <pre id="previewData">{}</pre>
            <div style="margin-top:20px;">
                <span style="font-size: 0.8rem; color: #aaa;">PROJECT QR IDENTIFIER:</span><br>
                <div id="qrcode"></div>
            </div>
            <button class="btn-main bg-zip" id="zipBtn" onclick="generateZip()">üì¶ EXPORT BUNDLE (.ZIP)</button>
        </div>
    </div>
</div>

<script>
    // --- B·∫¢O HI·ªÇM TH∆Ø VI·ªÜN ---
    function checkLib() {
        if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined' || typeof JSZip === 'undefined') {
            alert("‚ö†Ô∏è Libraries are not ready. System will reload in 2s.");
            location.reload(); return false;
        }
        return true;
    }

    // 1. T·∫¢I DANH S√ÅCH T·ª™ FILE JSON C·ª§C B·ªò
    async function initTemplates() {
        const list = document.getElementById('templateList');
        const status = document.getElementById('status');
        try {
            // Fetch file templates.json c√πng c·∫•p tr√™n Repo
            const response = await fetch('templates.json');
            if (!response.ok) throw new Error("File templates.json not found!");
            const templates = await response.json();
            
            list.innerHTML = "";
            templates.forEach(d => {
                list.innerHTML += `<label class="tpl-item"><input type="checkbox" class="tpl-check" value="${d.url}" data-name="${d.name}"> &nbsp; ${d.name}</label>`;
            });
            status.innerText = "‚úÖ Templates loaded from JSON successfully.";
        } catch (e) {
            list.innerHTML = "Error loading templates. Check if templates.json exists.";
            status.innerHTML = `<span style='color:red'>Error: ${e.message}</span>`;
        }
    }

    function toggleAll(s) { document.querySelectorAll('.tpl-check').forEach(el => el.checked = s); }

    // 2. QU√âT TAG T·ª™ FILE WORD
    async function scanAll() {
        if (!checkLib()) return;
        const checked = document.querySelectorAll('.tpl-check:checked');
        if(checked.length === 0) return alert("Please select at least one template!");
        
        const status = document.getElementById('status');
        const container = document.getElementById('fields');
        status.innerText = "Scanning documents for tags...";
        
        const allTags = new Set();
        try {
            for (let input of checked) {
                const res = await fetch(input.value);
                const zip = new PizZip(await res.arrayBuffer());
                const content = zip.files["word/document.xml"].asText();
                const regex = /\{([^{}]+)\}/g;
                let m;
                while ((m = regex.exec(content)) !== null) {
                    let t = m[1].replace(/<[^>]+>/g, "").trim();
                    if(t) allTags.add(t);
                }
            }

            container.innerHTML = "<strong>Data Entry:</strong><br><br>";
            allTags.forEach(t => {
                const isLong = t.toUpperCase().includes("DESCRIP") || t.toUpperCase().includes("NOTE");
                const inputHtml = isLong 
                    ? `<textarea class="input-tag t-val" oninput="updateUI(this)" placeholder="Enter content for ${t}..."></textarea>`
                    : `<input type="text" class="input-tag t-val" oninput="updateUI(this)" placeholder="Enter content for ${t}...">`;

                container.innerHTML += `
                    <div class="field-box">
                        <span class="label">Field: ${t}</span>
                        <input type="hidden" class="t-key" value="${t}">
                        ${inputHtml}
                    </div>`;
            });

            document.getElementById('formArea').style.display = "flex";
            document.getElementById('zipBtn').style.display = "block";
            status.innerText = "Found " + allTags.size + " unique tags.";
            updateUI();
        } catch (e) { status.innerText = "Error: " + e.message; }
    }

    function updateUI(el) {
        if(el) {
            const box = el.closest('.field-box');
            box.classList.toggle('empty', !el.value.trim());
        }
        
        const data = {};
        document.querySelectorAll('.t-key').forEach((k, i) => {
            data[k.value] = document.querySelectorAll('.t-val')[i].value || "";
        });
        document.getElementById('previewData').innerText = JSON.stringify(data, null, 4);

        const qrDiv = document.getElementById("qrcode");
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: "ID_" + new Date().getTime(), width: 80, height: 80 });
    }

    // 3. XU·∫§T FILE ZIP
    async function generateZip() {
        if (!checkLib()) return;
        const checked = document.querySelectorAll('.tpl-check:checked');
        const zipOutput = new JSZip();
        const data = JSON.parse(document.getElementById('previewData').innerText);

        document.getElementById('status').innerText = "Generating ZIP bundle...";
        try {
            for (let input of checked) {
                const res = await fetch(input.value);
                const pZip = new PizZip(await res.arrayBuffer());
                const doc = new window.docxtemplater(pZip, { paragraphLoop: true, linebreaks: true });
                doc.render(data);
                const out = doc.getZip().generate({ type: "blob" });
                zipOutput.file(`${input.getAttribute('data-name')}.docx`, out);
            }
            const zipBlob = await zipOutput.generateAsync({ type: "blob" });
            saveAs(zipBlob, `Project_Documents_${new Date().getTime()}.zip`);
            document.getElementById('status').innerText = "Done! Bundle downloaded.";
        } catch (e) { alert("Generation Error: " + e.message); }
    }

    // Kh·ªüi ƒë·ªông khi load trang
    window.addEventListener('DOMContentLoaded', initTemplates);
</script>
</body>
</html>
