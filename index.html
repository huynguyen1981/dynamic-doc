<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dynamic Doc - GitHub Pages Version</title>
    <script src="config.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .field-group { margin-bottom: 12px; display: flex; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 5px solid #007bff; }
        .tag-name { width: 140px; font-weight: bold; color: #555; }
        input, select { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        #status { text-align: center; color: #007bff; font-weight: bold; margin: 10px 0; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center">üìù Tr√¨nh T·∫°o VƒÉn B·∫£n T·ª± ƒê·ªông</h2>
    <label>1. Ch·ªçn m·∫´u bi·ªÉu m·∫´u:</label>
    <select id="templateSelect" onchange="autoScanTags()"></select>
    
    <div id="status"></div>

    <div id="fieldsContainer" style="margin-top:20px">
        <p style="text-align:center; color:#999;">(Tag s·∫Ω t·ª± ƒë·ªông hi·ªán ra sau khi ch·ªçn m·∫´u)</p>
    </div>
    
    <button onclick="generateAndDownload()">XU·∫§T FILE WORD (.DOCX)</button>
</div>

<script>
    // 1. Kh·ªüi t·∫°o Firebase t·ª´ file config.js c·ªßa b·ªì
    if (window.firebaseConfig) firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    // 2. Load danh s√°ch m·∫´u t·ª´ Firestore
    db.collection("templates").onSnapshot(snapshot => {
        const select = document.getElementById('templateSelect');
        select.innerHTML = '<option value="">-- Ch·ªçn m·∫´u vƒÉn b·∫£n --</option>';
        snapshot.forEach(doc => {
            const data = doc.data();
            select.add(new Option(data.name, data.url)); // data.url b√¢y gi·ªù l√† "templates/mau_test.docx"
        });
    });

    // 3. T·ª± ƒë·ªông qu√©t tag t·ª´ file
    async function autoScanTags() {
        const url = document.getElementById('templateSelect').value;
        const container = document.getElementById('fieldsContainer');
        const status = document.getElementById('status');
        if(!url) return;

        status.innerText = "‚è≥ ƒêang qu√©t file m·∫´u...";
        container.innerHTML = "";

        try {
            // Fetch tr·ª±c ti·∫øp (kh√¥ng c·∫ßn proxy) v√¨ c√πng host GitHub Pages
            const response = await fetch(url);
            if (!response.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file t·∫°i " + url);
            const arrayBuffer = await response.arrayBuffer();
            
            // D√πng JSZip x·ª≠ l√Ω n·ªôi dung Word
            const zip = await JSZip.loadAsync(arrayBuffer);
            const docXml = await zip.file("word/document.xml").async("string");
            
            // Regex h·ªët tag trong ngo·∫∑c { }
            const regex = /\{([^{}]+)\}/g;
            const tags = new Set();
            let match;
            while ((match = regex.exec(docXml)) !== null) {
                const cleanTag = match[1].replace(/<[^>]+>/g, "").trim();
                if(cleanTag) tags.add(cleanTag);
            }

            status.innerText = `‚úÖ ƒê√£ t√¨m th·∫•y ${tags.size} tr∆∞·ªùng d·ªØ li·ªáu!`;
            tags.forEach(tag => {
                container.innerHTML += `
                    <div class="field-group">
                        <span class="tag-name">${tag}:</span>
                        <input type="hidden" class="tag-key" value="${tag}">
                        <input type="text" class="tag-val" placeholder="Nh·∫≠p n·ªôi dung cho ${tag}...">
                    </div>`;
            });
        } catch (e) {
            status.innerHTML = `<span style="color:red">L·ªói: ${e.message}</span>`;
        }
    }

    // 4. ƒêi·ªÅn d·ªØ li·ªáu v√† Xu·∫•t file
    async function generateAndDownload() {
        const url = document.getElementById('templateSelect').value;
        if(!url) return alert("B·ªì ch∆∞a ch·ªçn m·∫´u!");

        const data = {};
        const keys = document.querySelectorAll('.tag-key');
        const vals = document.querySelectorAll('.tag-val');
        keys.forEach((k, i) => data[k.value] = vals[i].value || "...");

        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            const zip = await JSZip.loadAsync(arrayBuffer);
            
            const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
            doc.render(data); // ƒê·ªï d·ªØ li·ªáu v√†o tag

            const out = doc.getZip().generate({ 
                type: "blob", 
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" 
            }); //

            saveAs(out, "Van_Ban_Hoan_Thien.docx");
        } catch (e) {
            alert("L·ªói xu·∫•t file: " + e.message);
        }
    }
</script>
</body>
</html>