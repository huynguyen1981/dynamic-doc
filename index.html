<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng H·ªì S∆° Th√¥ng Minh - Pro Max</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>

    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #212529; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; line-height: 1.6; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); text-transform: uppercase; margin-bottom: 25px; }
        
        /* Toolbar */
        .toolbar { margin-bottom: 10px; display: flex; gap: 10px; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; background: #fff; transition: 0.2s; }
        .btn-small:hover { background: #e9ecef; }

        .template-list { border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto; background: #fff; margin-bottom: 20px; }
        .tpl-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f8f9fa; cursor: pointer; border-radius: 4px; }
        .tpl-item:hover { background: #f1f3f5; }
        
        /* Layout chia ƒë√¥i */
        .main-layout { display: flex; gap: 25px; margin-top: 20px; flex-wrap: wrap; }
        .input-section { flex: 1.2; min-width: 350px; }
        .preview-section { flex: 0.8; min-width: 300px; background: var(--dark); color: #00ff00; padding: 20px; border-radius: 10px; font-family: 'Consolas', 'Monaco', monospace; position: sticky; top: 20px; height: fit-content; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        
        .field-box { background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #dee2e6; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .label { font-weight: bold; font-size: 0.85rem; color: #495057; display: block; margin-bottom: 6px; }
        .input-tag { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .input-tag:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,123,255,0.15); }
        
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 1rem; transition: 0.3s; margin-top: 10px; }
        .bg-scan { background: var(--success); }
        .bg-scan:hover { background: #218838; }
        .bg-zip { background: var(--danger); display: none; }
        .bg-zip:hover { background: #c82333; }
        
        #status { text-align: center; margin: 15px; font-weight: bold; color: var(--primary); padding: 10px; border-radius: 6px; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 0.85rem; margin: 0; }
        .preview-title { color: #ffc107; font-size: 0.9rem; font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 8px; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìÑ H·ªá Th·ªëng H·ªì S∆° D·ª± √Ån</h2>
    
    <strong>1. Ch·ªçn danh m·ª•c t√†i li·ªáu c·∫ßn xu·∫•t:</strong>
    <div class="toolbar">
        <button class="btn-small" onclick="toggleAll(true)">‚úÖ Ch·ªçn t·∫•t c·∫£</button>
        <button class="btn-small" onclick="toggleAll(false)">‚ùå B·ªè ch·ªçn</button>
    </div>
    <div id="templateList" class="template-list">ƒêang k·∫øt n·ªëi Firestore...</div>
    
    <button class="btn-main bg-scan" onclick="scanAll()">üîç QU√âT D·ªÆ LI·ªÜU T·ª™ C√ÅC M·∫™U</button>
    <div id="status"></div>

    <div class="main-layout" id="formArea" style="display: none;">
        <div class="input-section">
            <strong style="display:block; margin-bottom:15px;">2. ƒêi·ªÅn th√¥ng tin v√†o c√°c tr∆∞·ªùng:</strong>
            <div id="fields"></div>
        </div>
        <div class="preview-section">
            <span class="preview-title">üì∫ D·ªÆ LI·ªÜU ƒêANG NH·∫¨P (LIVE)</span>
            <pre id="previewData">{}</pre>
            <button class="btn-main bg-zip" id="zipBtn" onclick="generateZip()">üì¶ XU·∫§T B·ªò T√ÄI LI·ªÜU (.ZIP)</button>
        </div>
    </div>
</div>

<script>
    // --- CH·ªêT CH·∫∂N B·∫¢O HI·ªÇM: CHECK TH∆Ø VI·ªÜN ---
    function checkLibraries() {
        if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined') {
            alert("‚ö†Ô∏è Th∆∞ vi·ªán ch∆∞a n·∫°p k·ªãp, b·ªì ƒë·ª£i 2 gi√¢y r·ªìi th·ª≠ l·∫°i nh√©!");
            location.reload();
            return false;
        }
        return true;
    }

    // Kh·ªüi t·∫°o Firebase
    if (window.firebaseConfig) firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    // Load danh s√°ch m·∫´u t·ª´ Firestore
    db.collection("templates").onSnapshot(snap => {
        const list = document.getElementById('templateList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            list.innerHTML += `<label class="tpl-item"><input type="checkbox" class="tpl-check" value="${d.url}" data-name="${d.name}"> &nbsp; ${d.name}</label>`;
        });
    }, err => {
        document.getElementById('status').innerHTML = "<span style='color:red'>L·ªói Firestore: " + err.message + "</span>";
    });

    // Ch·ªçn/B·ªè ch·ªçn t·∫•t c·∫£
    function toggleAll(status) {
        document.querySelectorAll('.tpl-check').forEach(el => el.checked = status);
    }

    // Qu√©t Tag v√† Hi·ªÉn th·ªã Form
    async function scanAll() {
        if (!checkLibraries()) return; // Ki·ªÉm tra th∆∞ vi·ªán tr∆∞·ªõc khi ch·∫°y

        const checked = document.querySelectorAll('.tpl-check:checked');
        if(checked.length === 0) return alert("B·ªì ∆°i, ch·ªçn √≠t nh·∫•t 1 m·∫´u t√†i li·ªáu ƒë√£!");
        
        const status = document.getElementById('status');
        const container = document.getElementById('fields');
        status.innerText = "‚è≥ ƒêang ph√¢n t√≠ch " + checked.length + " file m·∫´u...";
        
        const allTags = new Set();
        const now = new Date();

        try {
            for (let input of checked) {
                const res = await fetch(input.value);
                const zip = new PizZip(await res.arrayBuffer());
                const content = zip.files["word/document.xml"].asText();
                const regex = /\{([^{}]+)\}/g;
                let m;
                while ((m = regex.exec(content)) !== null) {
                    let t = m[1].replace(/<[^>]+>/g, "").trim();
                    if(t) allTags.add(t);
                }
            }

            container.innerHTML = "";
            allTags.forEach(t => {
                let val = "";
                const T = t.toUpperCase();
                if(T === "NGAY") val = now.getDate();
                if(T === "THANG") val = now.getMonth() + 1;
                if(T === "NAM") val = now.getFullYear();

                container.innerHTML += `
                    <div class="field-box">
                        <span class="label">TR∆Ø·ªúNG D·ªÆ LI·ªÜU: ${t}</span>
                        <input type="hidden" class="t-key" value="${t}">
                        <input type="text" class="input-tag t-val" value="${val}" oninput="updatePreview()" placeholder="Nh·∫≠p n·ªôi dung cho ${t}...">
                    </div>`;
            });

            document.getElementById('formArea').style.display = "flex";
            document.getElementById('zipBtn').style.display = "block";
            status.innerText = `‚úÖ ƒê√£ qu√©t xong! M·ªùi b·ªì nh·∫≠p li·ªáu.`;
            updatePreview();
        } catch (e) { 
            status.innerHTML = `<span style='color:red'>L·ªói: ${e.message}</span>`;
        }
    }

    // Live Preview
    function updatePreview() {
        const data = {};
        const keys = document.querySelectorAll('.t-key');
        const vals = document.querySelectorAll('.t-val');
        keys.forEach((k, i) => {
            data[k.value] = vals[i].value || "...";
        });
        document.getElementById('previewData').innerText = JSON.stringify(data, null, 4);
    }

    // Xu·∫•t Zip
    async function generateZip() {
        if (!checkLibraries()) return;

        const checked = document.querySelectorAll('.tpl-check:checked');
        const zipOutput = new JSZip();
        const data = JSON.parse(document.getElementById('previewData').innerText);

        document.getElementById('status').innerText = "‚è≥ ƒêang t·∫°o b·ªô h·ªì s∆° Zip...";
        try {
            for (let input of checked) {
                const res = await fetch(input.value);
                const pZip = new PizZip(await res.arrayBuffer());
                const doc = new window.docxtemplater(pZip, { paragraphLoop: true, linebreaks: true });
                doc.render(data);
                const out = doc.getZip().generate({ type: "blob" });
                zipOutput.file(`${input.getAttribute('data-name')}.docx`, out);
            }
            const zipBlob = await zipOutput.generateAsync({ type: "blob" });
            saveAs(zipBlob, `Bo_Ho_So_${new Date().getTime()}.zip`);
            document.getElementById('status').innerText = "üöÄ Th√†nh c√¥ng! File ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ.";
        } catch (e) { 
            alert("L·ªói xu·∫•t file: " + e.message); 
        }
    }
</script>
</body>
</html>
