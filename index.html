<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Doc Generator - Professional</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --primary: #2563eb; --success: #059669; --bg: #f8fafc; --border: #e2e8f0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: #1e293b; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        .header { border-bottom: 2px solid var(--bg); margin-bottom: 30px; padding-bottom: 20px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 1.8rem; }
        
        /* H∆∞·ªõng d·∫´n ng∆∞·ªùi d√πng */
        .guide-section { background: #eff6ff; border-radius: 8px; padding: 20px; margin-bottom: 30px; border: 1px solid #dbeafe; }
        .guide-section h3 { margin-top: 0; font-size: 1rem; color: #1e40af; }
        .guide-list { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem; }
        .tag-info { background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #bfdbfe; font-family: monospace; }

        /* Template List */
        .card { border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 25px; }
        .tpl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .tpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tpl-item { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #f1f5f9; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .tpl-item:hover { background: #f1f5f9; }
        .tpl-item input { width: 18px; height: 18px; margin: 0; }

        /* Form Inputs */
        .main-form { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 30px; border-top: 2px solid var(--bg); padding-top: 30px; }
        .field-group { margin-bottom: 15px; }
        .field-group label { display: block; font-weight: 600; font-size: 0.85rem; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        .input-style { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .input-style:focus { outline: none; border-color: var(--primary); ring: 2px solid #bfdbfe; }

        /* Buttons */
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .btn-p { background: var(--primary); color: white; width: 100%; }
        .btn-p:hover { background: #1d4ed8; }
        .btn-s { background: var(--success); color: white; width: 100%; margin-top: 20px; }
        .btn-link { background: none; color: var(--primary); padding: 0; font-size: 0.85rem; text-decoration: underline; }

        #status { text-align: center; margin: 20px 0; font-weight: 600; color: var(--primary); font-size: 0.9rem; }
        .preview-json { background: #1e293b; color: #10b981; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.8rem; overflow: auto; max-height: 300px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üìÑ Global Doc Generator Pro</h1>
        <p style="color: #64748b; margin: 5px 0 0 0;">C√¥ng c·ª• t·∫°o h·ªì s∆° h√†ng lo·∫°t ch√≠nh x√°c & chuy√™n nghi·ªáp</p>
    </div>

    <div class="guide-section">
        <h3>üí° H∆∞·ªõng d·∫´n ƒë·∫∑t Tag trong file Word m·∫´u:</h3>
        <div class="guide-list">
            <div class="tag-info"><b>{TEN_KH}</b><br>Nh·∫≠p vƒÉn b·∫£n th∆∞·ªùng</div>
            <div class="tag-info"><b>{d%NGAY_SINH}</b><br>Ch·ªçn ng√†y t·ª´ l·ªãch</div>
            <div class="tag-info"><b>{%CHU_KY}</b><br>Ch√®n h√¨nh ·∫£nh (·∫£nh/k√Ω)</div>
        </div>
    </div>

    <div class="card">
        <div class="tpl-header">
            <strong style="font-size: 1.1rem;">B∆∞·ªõc 1: Ch·ªçn c√°c m·∫´u c·∫ßn xu·∫•t</strong>
            <div>
                <button class="btn-link" onclick="toggleAll(true)">Ch·ªçn t·∫•t c·∫£</button> | 
                <button class="btn-link" onclick="toggleAll(false)">B·ªè ch·ªçn</button>
            </div>
        </div>
        <div id="templateList" class="tpl-grid">ƒêang t·∫£i danh s√°ch m·∫´u...</div>
        <button class="btn btn-p" style="margin-top: 20px;" onclick="analyzeTemplates()">üîç QU√âT D·ªÆ LI·ªÜU T·ª™ M·∫™U ƒê√É CH·ªåN</button>
    </div>

    <div id="status">H·ªá th·ªëng ƒë√£ s·∫µn s√†ng l√†m vi·ªác.</div>

    <div id="mainWorkArea" style="display: none;" class="main-form">
        <div class="form-inputs">
            <strong style="display: block; margin-bottom: 20px; font-size: 1.1rem;">B∆∞·ªõc 2: Nh·∫≠p th√¥ng tin h·ªì s∆°</strong>
            <div id="dynamicInputs"></div>
        </div>
        <div class="form-side">
            <strong style="display: block; margin-bottom: 20px; font-size: 1.1rem;">B∆∞·ªõc 3: Ki·ªÉm tra & T·∫£i v·ªÅ</strong>
            <div class="preview-json">
                <pre id="jsonDisplay">{}</pre>
            </div>
            <button class="btn btn-s" id="downloadBtn" onclick="generateZip()">üì¶ T·∫¢I XU·ªêNG B·ªò H·ªí S∆† (.ZIP)</button>
        </div>
    </div>
</div>

<script>
    let imageData = {};

    // Kh·ªüi t·∫°o danh s√°ch t·ª´ JSON
    async function init() {
        try {
            const res = await fetch('templates.json');
            const data = await res.json();
            document.getElementById('templateList').innerHTML = data.map(t => `
                <label class="tpl-item">
                    <input type="checkbox" class="tpl-check" value="${t.url}" data-name="${t.name}">
                    <span>${t.name}</span>
                </label>
            `).join('');
        } catch (e) {
            document.getElementById('status').innerText = "‚ùå Kh√¥ng t√¨m th·∫•y file templates.json!";
        }
    }

    function toggleAll(state) {
        document.querySelectorAll('.tpl-check').forEach(c => c.checked = state);
    }

    // Qu√©t tag t·ª´ file Word
    async function analyzeTemplates() {
        const checked = document.querySelectorAll('.tpl-check:checked');
        if (checked.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m·∫´u vƒÉn b·∫£n!");

        document.getElementById('status').innerText = "‚è≥ ƒêang ph√¢n t√≠ch m·∫´u, vui l√≤ng ƒë·ª£i...";
        const tags = { text: new Set(), date: new Set(), img: new Set() };

        try {
            for (let item of checked) {
                const res = await fetch(item.value);
                if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i file: " + item.value);
                const zip = new PizZip(await res.arrayBuffer());
                const content = zip.files["word/document.xml"].asText();
                const matches = content.match(/\{([^{}]+)\}/g) || [];
                
                matches.forEach(m => {
                    let tag = m.replace(/<[^>]+>/g, "").replace(/[{}]/g, "").trim();
                    if(tag.startsWith('%')) tags.img.add(tag.substring(1));
                    else if(tag.startsWith('d%')) tags.date.add(tag);
                    else tags.text.add(tag);
                });
            }
            renderInputs(tags);
            document.getElementById('status').innerText = "‚úÖ ƒê√£ qu√©t xong! M·ªùi b·∫°n nh·∫≠p d·ªØ li·ªáu.";
        } catch (e) {
            document.getElementById('status').innerText = "‚ùå L·ªói: " + e.message;
        }
    }

    function renderInputs(tags) {
        const container = document.getElementById('dynamicInputs');
        container.innerHTML = "";
        
        tags.img.forEach(t => container.innerHTML += makeField(t, 'üì∑ H√¨nh ·∫£nh / Ch·ªØ k√Ω', 'file'));
        tags.date.forEach(t => container.innerHTML += makeField(t, 'üìÖ Ng√†y th√°ng', 'date'));
        tags.text.forEach(t => container.innerHTML += makeField(t, '‚úçÔ∏è VƒÉn b·∫£n', 'text'));

        document.getElementById('mainWorkArea').style.display = "grid";
        updatePreview();
    }

    function makeField(tag, labelHint, type) {
        let cleanLabel = tag.startsWith('d%') ? tag.substring(2) : tag;
        let event = type === 'file' ? `onchange="handleImg('${tag}', this)"` : `oninput="updatePreview()"`;
        let val = type === 'date' ? new Date().toISOString().split('T')[0] : "";
        return `
            <div class="field-group">
                <label>${cleanLabel} (${labelHint})</label>
                <input type="${type}" class="input-style t-val" data-tag="${tag}" value="${val}" ${event}>
            </div>`;
    }

    function handleImg(tag, input) {
        const reader = new FileReader();
        reader.onload = (e) => { imageData[tag] = e.target.result; updatePreview(); };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function updatePreview() {
        const data = {};
        document.querySelectorAll('.t-val').forEach(i => {
            let tag = i.getAttribute('data-tag');
            if (i.type === 'date') {
                const [y, m, d] = i.value.split('-');
                data[tag] = `${m}/${d}/${y}`;
            } else if (i.type !== 'file') {
                data[tag] = i.value;
            }
        });
        document.getElementById('jsonDisplay').innerText = JSON.stringify(data, null, 4);
    }

    async function generateZip() {
        document.getElementById('status').innerText = "‚è≥ ƒêang t·∫°o file ZIP, vui l√≤ng kh√¥ng ƒë√≥ng tr√¨nh duy·ªát...";
        const zipOut = new JSZip();
        const data = JSON.parse(document.getElementById('jsonDisplay').innerText);
        const checked = document.querySelectorAll('.tpl-check:checked');

        try {
            // Kh·ªüi t·∫°o Image Module n·∫øu c√≥ ·∫£nh
            let imgModule = null;
            if (typeof window.ImageModule !== 'undefined' || typeof window.DocxtemplaterImageModuleV2 !== 'undefined') {
                const ImgModClass = window.DocxtemplaterImageModuleV2 || window.ImageModule;
                imgModule = new ImgModClass({
                    getImage: (t) => imageData[t],
                    getSize: (img, t) => t.toLowerCase().includes('logo') ? [120, 120] : [150, 60]
                });
            }

            for (let c of checked) {
                const res = await fetch(c.value);
                const doc = new window.docxtemplater(new PizZip(await res.arrayBuffer()), { 
                    modules: imgModule ? [imgModule] : [],
                    paragraphLoop: true,
                    linebreaks: true
                });
                doc.render(data);
                zipOut.file(`${c.getAttribute('data-name')}.docx`, doc.getZip().generate({type:"blob"}));
            }
            
            const content = await zipOut.generateAsync({type:"blob"});
            saveAs(content, `HoSo_Bundle_${Date.now()}.zip`);
            document.getElementById('status').innerText = "üöÄ Ho√†n t·∫•t! File ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ.";
        } catch (e) {
            alert("L·ªói khi t·∫°o file: " + e.message);
        }
    }

    window.onload = init;
</script>
</body>
</html>
