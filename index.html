<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Doc Generator Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docxtemplater-image-module-free@1.1.1/build/bundle.js"></script>

    <style>
        :root { --p: #2563eb; --s: #059669; --bg: #f8fafc; --gray: #64748b; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: #1e293b; padding: 20px; margin: 0; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.7rem; color: var(--p); letter-spacing: -0.5px; }
        .guide { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .guide-card { background: #eff6ff; padding: 15px; border-radius: 10px; border: 1px solid #dbeafe; font-size: 0.85rem; }
        .guide-card code { display: block; color: var(--p); font-weight: 700; margin-bottom: 5px; font-size: 1rem; }
        .card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .card-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title strong { font-size: 1.1rem; }
        .tpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tpl-item { display: flex; align-items: center; padding: 12px 15px; border: 1px solid #f1f5f9; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .tpl-item:hover { background: #f8fafc; border-color: var(--p); }
        .tpl-item input { margin-right: 12px; width: 18px; height: 18px; cursor: pointer; }
        .work-area { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 40px; border-top: 2px solid #f1f5f9; padding-top: 30px; }
        .field-box { margin-bottom: 18px; }
        .field-box label { display: block; font-weight: 600; font-size: 0.8rem; color: var(--gray); margin-bottom: 6px; text-transform: uppercase; }
        .input-control { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; transition: 0.2s; box-sizing: border-box; }
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; width: 100%; font-size: 1rem; }
        .btn-p { background: var(--p); color: white; margin-top: 10px; }
        .btn-s { background: var(--s); color: white; margin-top: 20px; display: none; }
        .preview-pane { background: #0f172a; border-radius: 12px; padding: 20px; color: #34d399; font-family: 'Fira Code', monospace; font-size: 0.8rem; overflow-x: auto; max-height: 400px; }
        #status { text-align: center; margin: 20px 0; font-weight: 600; color: var(--p); min-height: 24px; }
        .link-action { color: var(--p); background: none; border: none; text-decoration: underline; cursor: pointer; font-size: 0.85rem; padding: 0 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="background: var(--p); color: white; padding: 10px; border-radius: 10px;">üìÑ</div>
        <div>
            <h1>Global Doc Generator Pro</h1>
            <small style="color: var(--gray)">Gi·∫£i ph√°p t·∫°o h·ªì s∆° h√†ng lo·∫°t ch√≠nh x√°c & chuy√™n nghi·ªáp</small>
        </div>
    </div>

    <div class="guide">
        <div class="guide-card"><code>{TEN_KH}</code> VƒÉn b·∫£n b√¨nh th∆∞·ªùng</div>
        <div class="guide-card"><code>{d%NGAY_SINH}</code> Ch·ªçn ng√†y t·ª´ l·ªãch</div>
        <div class="guide-card"><code>{%CHU_KY}</code> Ch√®n h√¨nh ·∫£nh (·∫£nh/k√Ω)</div>
    </div>

    <div class="card">
        <div class="card-title">
            <strong>1. Ch·ªçn c√°c m·∫´u c·∫ßn xu·∫•t</strong>
            <div>
                <button class="link-action" onclick="selAll(true)">Ch·ªçn t·∫•t c·∫£</button> | 
                <button class="link-action" onclick="selAll(false)">B·ªè ch·ªçn</button>
            </div>
        </div>
        <div id="tplList" class="tpl-grid">ƒêang t·∫£i danh s√°ch m·∫´u...</div>
        <button class="btn btn-p" onclick="analyze()">üîç QU√âT D·ªÆ LI·ªÜU T·ª™ M·∫™U ƒê√É CH·ªåN</button>
    </div>

    <div id="status">H·ªá th·ªëng s·∫µn s√†ng.</div>

    <div id="workZone" class="work-area" style="display: none;">
        <div>
            <strong style="display: block; margin-bottom: 20px;">2. Nh·∫≠p d·ªØ li·ªáu</strong>
            <div id="inputs"></div>
        </div>
        <div>
            <strong style="display: block; margin-bottom: 20px;">3. Preview & Download</strong>
            <div class="preview-pane"><pre id="jsonOut">{}</pre></div>
            <button class="btn btn-s" id="zipBtn" onclick="buildZip()">üì¶ T·∫¢I B·ªò H·ªí S∆† (.ZIP)</button>
        </div>
    </div>
</div>

<script>
    let imgData = {}; // L∆∞u tr·ªØ ArrayBuffer c·ªßa ·∫£nh

    async function init() {
        try {
            const res = await fetch('templates.json');
            const data = await res.json();
            document.getElementById('tplList').innerHTML = data.map(t => `
                <label class="tpl-item">
                    <input type="checkbox" class="tpl-check" value="${t.url}" data-name="${t.name}">
                    <span>${t.name}</span>
                </label>
            `).join('');
        } catch (e) { document.getElementById('status').innerText = "L·ªói n·∫°p file c·∫•u h√¨nh!"; }
    }

    function selAll(s) { document.querySelectorAll('.tpl-check').forEach(c => c.checked = s); }

    async function analyze() {
        const checked = document.querySelectorAll('.tpl-check:checked');
        if (checked.length === 0) return alert("B·ªì ch∆∞a ch·ªçn m·∫´u n√†o k√¨a!");

        document.getElementById('status').innerText = "‚è≥ ƒêang ph√¢n t√≠ch m·∫´u...";
        const tags = { text: new Set(), date: new Set(), img: new Set() };

        try {
            for (let item of checked) {
                const res = await fetch(item.value);
                const zip = new PizZip(await res.arrayBuffer());
                const content = zip.files["word/document.xml"].asText();
                const matches = content.match(/\{([^{}]+)\}/g) || [];
                
                matches.forEach(m => {
                    let t = m.replace(/<[^>]+>/g, "").replace(/[{}]/g, "").trim();
                    if(t.startsWith('%')) tags.img.add(t.substring(1));
                    else if(t.startsWith('d%')) tags.date.add(t);
                    else tags.text.add(t);
                });
            }
            renderInputs(tags);
            document.getElementById('status').innerText = "‚úÖ ƒê√£ nh·∫≠n di·ªán xong c√°c tr∆∞·ªùng d·ªØ li·ªáu!";
        } catch (e) { document.getElementById('status').innerText = "L·ªói: " + e.message; }
    }

    function renderInputs(tags) {
        const container = document.getElementById('inputs');
        container.innerHTML = "";
        // ∆Øu ti√™n hi·ªÉn th·ªã upload ·∫£nh l√™n ƒë·∫ßu cho d·ªÖ th·∫•y
        tags.img.forEach(t => container.innerHTML += `
            <div class="field-box">
                <label>üì∑ UPLOAD: ${t}</label>
                <input type="file" class="input-control" onchange="handleFile('${t}', this)">
            </div>`);
        tags.date.forEach(t => container.innerHTML += makeInput(t, 'date', 'üìÖ NG√ÄY'));
        tags.text.forEach(t => container.innerHTML += makeInput(t, 'text', '‚úçÔ∏è D·ªÆ LI·ªÜU'));

        document.getElementById('workZone').style.display = "grid";
        document.getElementById('zipBtn').style.display = "block";
        updatePreview();
    }

    function makeInput(tag, type, hint) {
        let label = tag.startsWith('d%') ? tag.substring(2) : tag;
        let val = type === 'date' ? new Date().toISOString().split('T')[0] : "";
        return `<div class="field-box">
                    <label>${label} (${hint})</label>
                    <input type="${type}" class="input-control t-val" data-tag="${tag}" value="${val}" oninput="updatePreview()">
                </div>`;
    }

    // X·ª≠ l√Ω ƒë·ªçc file ·∫£nh th√†nh ArrayBuffer
    function handleFile(tag, input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imgData[tag] = e.target.result;
                updatePreview();
            };
            reader.readAsArrayBuffer(input.files[0]);
        }
    }

    function updatePreview() {
        const data = { "_images_uploaded": Object.keys(imgData) };
        document.querySelectorAll('.t-val').forEach(i => {
            let tag = i.getAttribute('data-tag');
            if (i.type === 'date') {
                const [y, m, d] = i.value.split('-');
                data[tag] = `${m}/${d}/${y}`;
            } else {
                data[tag] = i.value;
            }
        });
        document.getElementById('jsonOut').innerText = JSON.stringify(data, null, 4);
    }

    async function buildZip() {
        const checked = document.querySelectorAll('.tpl-check:checked');
        const zipOut = new JSZip();
        const data = JSON.parse(document.getElementById('jsonOut').innerText);

        // Kh·ªüi t·∫°o ImageModule v·ªõi c∆° ch·∫ø b·∫Øt l·ªói constructor
        const ImageModule = window.ImageModule || window.DocxtemplaterImageModuleV2;
        if (!ImageModule) return alert("L·ªói: Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán x·ª≠ l√Ω ·∫£nh!");

        const imageOptions = new ImageModule({
            centered: false,
            getImage: (tag) => imgData[tag],
            getSize: () => [150, 65] // K√≠ch th∆∞·ªõc ·∫£nh trong Word
        });

        try {
            document.getElementById('status').innerText = "‚è≥ ƒêang ƒë√≥ng g√≥i ZIP...";
            for (let c of checked) {
                const res = await fetch(c.value);
                const doc = new window.docxtemplater(new PizZip(await res.arrayBuffer()), { 
                    paragraphLoop: true, linebreaks: true,
                    modules: [imageOptions] // N·∫°p module ·∫£nh
                });
                doc.render(data);
                zipOut.file(`${c.getAttribute('data-name')}.docx`, doc.getZip().generate({type:"blob"}));
            }
            const content = await zipOut.generateAsync({type:"blob"});
            saveAs(content, `Bo_Ho_So_${Date.now()}.zip`);
            document.getElementById('status').innerText = "üöÄ Ho√†n t·∫•t! ƒê√£ t·∫£i xu·ªëng b·ªô h·ªì s∆°.";
        } catch (e) { 
            console.error(e);
            alert("L·ªói xu·∫•t file: " + e.message); 
        }
    }
    window.onload = init;
</script>
</body>
</html>
