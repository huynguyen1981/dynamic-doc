<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Doc - B·∫£n Ho√†n Thi·ªán</title>
    
    <script src="config.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 650px; margin: 40px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #007bff; margin-bottom: 25px; }
        label { font-weight: 600; display: block; margin-bottom: 8px; font-size: 0.9rem; }
        select { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        #status { text-align: center; font-weight: bold; margin-bottom: 15px; color: #28a745; min-height: 1.2em; }
        .field-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #007bff; display: flex; align-items: center; }
        .field-label { width: 150px; font-weight: bold; color: #555; text-transform: uppercase; font-size: 0.8rem; }
        .field-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        .btn-submit { background: #007bff; color: white; border: none; padding: 16px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; margin-top: 20px; }
        .btn-submit:hover { background: #0056b3; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Tr√¨nh T·∫°o VƒÉn B·∫£n T·ª± ƒê·ªông</h2>
    
    <label>1. Ch·ªçn m·∫´u t·ª´ danh s√°ch (Firestore):</label>
    <select id="templateSelect" onchange="autoScanTags()">
        <option value="">-- ƒêang t·∫£i danh s√°ch m·∫´u... --</option>
    </select>

    <div id="status"></div>

    <label>2. Nh·∫≠p th√¥ng tin chi ti·∫øt:</label>
    <div id="fieldsContainer">
        <p style="text-align: center; color: #999; font-style: italic;">Ch·ªçn m·ªôt m·∫´u ƒë·ªÉ hi·ªÉn th·ªã c√°c tr∆∞·ªùng d·ªØ li·ªáu.</p>
    </div>

    <button class="btn-submit" onclick="generateAndDownload()">XU·∫§T FILE WORD (.DOCX)</button>
</div>

<script>
    // --- KH·ªûI T·∫†O FIREBASE ---
    if (window.firebaseConfig) {
        firebase.initializeApp(window.firebaseConfig);
    }
    const db = firebase.firestore();

    // 1. T·∫£i danh s√°ch m·∫´u t·ª´ Firestore
    db.collection("templates").onSnapshot((snapshot) => {
        const select = document.getElementById('templateSelect');
        select.innerHTML = '<option value="">-- Ch·ªçn m·ªôt m·∫´u vƒÉn b·∫£n --</option>';
        snapshot.forEach((doc) => {
            const data = doc.data();
            select.add(new Option(data.name, data.url)); // Link t∆∞∆°ng ƒë·ªëi: templates/tenfile.docx
        });
    }, (err) => console.error("L·ªói Firestore:", err));

    // 2. T·ª± ƒë·ªông qu√©t tag { } t·ª´ file Word
    async function autoScanTags() {
        const url = document.getElementById('templateSelect').value;
        const container = document.getElementById('fieldsContainer');
        const status = document.getElementById('status');
        if (!url) {
            container.innerHTML = '<p style="text-align: center; color: #999;">Ch·ªçn m·ªôt m·∫´u ƒë·ªÉ hi·ªÉn th·ªã c√°c tr∆∞·ªùng d·ªØ li·ªáu.</p>';
            status.innerText = "";
            return;
        }

        status.innerText = "‚è≥ ƒêang qu√©t d·ªØ li·ªáu t·ª´ file m·∫´u...";
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i file m·∫´u. Ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n!");
            
            const arrayBuffer = await response.arrayBuffer();
            const zip = new PizZip(arrayBuffer);
            const docXml = zip.files["word/document.xml"].asText();
            
            // Regex t√¨m tag {TEN_TAG}
            const regex = /\{([^{}]+)\}/g;
            const tags = new Set();
            let match;
            while ((match = regex.exec(docXml)) !== null) {
                const cleanTag = match[1].replace(/<[^>]+>/g, "").trim();
                if (cleanTag) tags.add(cleanTag);
            }

            container.innerHTML = "";
            if (tags.size === 0) {
                status.innerHTML = "<span style='color:red'>‚ùå Kh√¥ng t√¨m th·∫•y tag { } n√†o!</span>";
            } else {
                status.innerText = `‚úÖ ƒê√£ t√¨m th·∫•y ${tags.size} tr∆∞·ªùng d·ªØ li·ªáu!`;
                tags.forEach(tag => {
                    const div = document.createElement('div');
                    div.className = 'field-box';
                    div.innerHTML = `
                        <div class="field-label">${tag}:</div>
                        <input type="hidden" class="tag-key" value="${tag}">
                        <input type="text" class="field-input tag-value" placeholder="Nh·∫≠p n·ªôi dung cho ${tag}...">
                    `;
                    container.appendChild(div);
                });
            }
        } catch (err) {
            status.innerHTML = `<span style='color:red'>L·ªói: ${err.message}</span>`;
            console.error(err);
        }
    }

    // 3. ƒêi·ªÅn d·ªØ li·ªáu v√† Xu·∫•t file Word
    async function generateAndDownload() {
        const url = document.getElementById('templateSelect').value;
        if (!url) return alert("B·ªì ∆°i, ch·ªçn m·∫´u tr∆∞·ªõc ƒë√£!");

        const data = {};
        const keys = document.querySelectorAll('.tag-key');
        const values = document.querySelectorAll('.tag-value');
        keys.forEach((key, index) => {
            data[key.value] = values[index].value || "...";
        });

        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            const zip = new PizZip(arrayBuffer);
            
            const doc = new window.docxtemplater(zip, { 
                paragraphLoop: true, 
                linebreaks: true 
            });

            doc.render(data);

            const out = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            });

            saveAs(out, "Van_Ban_Hoan_Thien.docx");
        } catch (err) {
            alert("L·ªói xu·∫•t file: " + err.message);
        }
    }
</script>
</body>
</html>
