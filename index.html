<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Xu·∫•t H·ªì S∆° D·ª± √Ån - B·∫£n Pro</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
        window.onload = function() {
            if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined') {
                console.warn("Th∆∞ vi·ªán ch∆∞a n·∫°p xong, ƒëang t·ª± ƒë·ªông n·∫°p l·∫°i...");
                setTimeout(() => { if(typeof PizZip === 'undefined') location.reload(); }, 1500);
            } else {
                console.log("H·ªá th·ªëng th∆∞ vi·ªán ƒë√£ s·∫µn s√†ng!");
            }
        };
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .template-list { border: 1px solid #ddd; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto; margin-bottom: 15px; }
        .tpl-item { display: block; padding: 5px 0; cursor: pointer; }
        .field-box { background: #e9ecef; padding: 10px; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; border-left: 4px solid #007bff; }
        .label { width: 140px; font-weight: bold; font-size: 0.9rem; }
        .input-tag { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-scan { background: #28a745; color: white; }
        .btn-zip { background: #dc3545; color: white; display: none; }
        #status { text-align: center; margin: 10px; font-style: italic; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìÑ H·ªá Th·ªëng Xu·∫•t H·ªì S∆° D·ª± √Ån</h2>
    
    <strong>1. Ch·ªçn c√°c m·∫´u t√†i li·ªáu:</strong>
    <div id="templateList" class="template-list">ƒêang t·∫£i danh s√°ch...</div>
    
    <button class="btn btn-scan" onclick="scanAll()">üîç QU√âT TO√ÄN B·ªò TAG</button>
    <div id="status"></div>

    <div id="fields"></div>
    
    <button class="btn btn-zip" id="zipBtn" onclick="generateZip()">üöÄ T·∫†I FILE ZIP H·ªí S∆†</button>
</div>

<script>
    if (window.firebaseConfig) firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    // T·∫£i danh s√°ch checkbox
    db.collection("templates").onSnapshot(snap => {
        const list = document.getElementById('templateList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            list.innerHTML += `<label class="tpl-item"><input type="checkbox" class="tpl-check" value="${d.url}" data-name="${d.name}"> ${d.name}</label>`;
        });
    });

    // Qu√©t tag t·ª´ c√°c m·∫´u ƒë√£ ch·ªçn
    async function scanAll() {
        const checked = document.querySelectorAll('.tpl-check:checked');
        if(checked.length === 0) return alert("B·ªì ch·ªçn m·∫´u ƒë√£!");
        
        const container = document.getElementById('fields');
        const status = document.getElementById('status');
        status.innerText = "‚è≥ ƒêang qu√©t file m·∫´u...";
        
        const allTags = new Set();
        const now = new Date();

        try {
            for (let input of checked) {
                const res = await fetch(input.value);
                const zip = new PizZip(await res.arrayBuffer());
                const content = zip.files["word/document.xml"].asText();
                const regex = /\{([^{}]+)\}/g;
                let m;
                while ((m = regex.exec(content)) !== null) {
                    let t = m[1].replace(/<[^>]+>/g, "").trim();
                    if(t) allTags.add(t);
                }
            }

            container.innerHTML = "<hr><strong>2. Nh·∫≠p th√¥ng tin chung:</strong><br><br>";
            allTags.forEach(t => {
                let val = "";
                if(t.toUpperCase() === "NGAY") val = now.getDate();
                if(t.toUpperCase() === "THANG") val = now.getMonth() + 1;
                if(t.toUpperCase() === "NAM") val = now.getFullYear();

                container.innerHTML += `<div class="field-box">
                    <span class="label">${t}:</span>
                    <input type="hidden" class="t-key" value="${t}">
                    <input type="text" class="input-tag t-val" value="${val}">
                </div>`;
            });
            status.innerText = `‚úÖ ƒê√£ gom ${allTags.size} tag!`;
            document.getElementById('zipBtn').style.display = "block";
        } catch (e) { status.innerText = "L·ªói: " + e.message; }
    }

    // Xu·∫•t Zip
    async function generateZip() {
        const checked = document.querySelectorAll('.tpl-check:checked');
        const zipOutput = new JSZip(); // Th∆∞ vi·ªán n√©n
        const data = {};
        document.querySelectorAll('.t-key').forEach((k, i) => {
            data[k.value] = document.querySelectorAll('.t-val')[i].value || "...";
        });

        try {
            for (let input of checked) {
                const res = await fetch(input.value);
                const pZip = new PizZip(await res.arrayBuffer());
                const doc = new window.docxtemplater(pZip, { paragraphLoop: true, linebreaks: true });
                doc.render(data);
                const out = doc.getZip().generate({ type: "blob" });
                zipOutput.file(`${input.getAttribute('data-name')}.docx`, out);
            }
            const zipBlob = await zipOutput.generateAsync({ type: "blob" });
            saveAs(zipBlob, `Ho_So_${new Date().getTime()}.zip`);
        } catch (e) { alert("L·ªói: " + e.message); }
    }
</script>
</body>
</html>
