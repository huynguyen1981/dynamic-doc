<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Doc - Final Fix</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="config.js"></script>
    <script>
        window.onload = function() {
            if (typeof PizZip === 'undefined') {
                console.log("Th∆∞ vi·ªán ch∆∞a n·∫°p, ƒëang th·ª≠ n·∫°p l·∫°i...");
                location.reload(); // T·ª± ƒë·ªông F5 n·∫øu n·∫°p l·ªói
            } else {
                console.log("PizZip ƒë√£ s·∫µn s√†ng!");
            }
        };
    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #007bff; }
        .field-box { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #007bff; display: flex; align-items: center; }
        .label { width: 120px; font-weight: bold; font-size: 0.85rem; color: #555; }
        input, select { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .btn { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #status { text-align: center; margin: 10px; font-weight: bold; color: #28a745; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìÑ Tr√¨nh T·∫°o VƒÉn B·∫£n</h2>
    <label>Ch·ªçn m·∫´u vƒÉn b·∫£n:</label>
    <select id="templateSelect" onchange="loadTags()"></select>
    
    <div id="status"></div>
    <div id="fields"></div>
    
    <button class="btn" onclick="generate()">XU·∫§T FILE WORD (.DOCX)</button>
</div>

<script>
    // Kh·ªüi t·∫°o Firebase
    if (window.firebaseConfig) firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    // L·∫•y danh s√°ch t·ª´ Firestore
    db.collection("templates").onSnapshot(snap => {
        const sel = document.getElementById('templateSelect');
        sel.innerHTML = '<option value="">-- Ch·ªçn m·∫´u --</option>';
        snap.forEach(doc => sel.add(new Option(doc.data().name, doc.data().url)));
    });

    async function loadTags() {
        const url = document.getElementById('templateSelect').value;
        if (!url) return;
        
        const status = document.getElementById('status');
        const container = document.getElementById('fields');
        status.innerText = "‚è≥ ƒêang qu√©t m·∫´u...";

        try {
            const res = await fetch(url);
            const buffer = await res.arrayBuffer();
            
            // D√πng PizZip ƒë√∫ng c√°ch
            const zip = new PizZip(buffer);
            const content = zip.files["word/document.xml"].asText();
            
            const tags = new Set();
            const regex = /\{([^{}]+)\}/g;
            let m;
            while ((m = regex.exec(content)) !== null) {
                let t = m[1].replace(/<[^>]+>/g, "").trim();
                if(t) tags.add(t);
            }

            container.innerHTML = "";
            tags.forEach(t => {
                container.innerHTML += `<div class="field-box">
                    <span class="label">${t}:</span>
                    <input type="hidden" class="t-key" value="${t}">
                    <input type="text" class="t-val" placeholder="Nh·∫≠p ${t}...">
                </div>`;
            });
            status.innerText = `‚úÖ ƒê√£ th·∫•y ${tags.size} tag!`;
        } catch (e) {
            status.innerHTML = `<span style="color:red">L·ªói: ${e.message}</span>`;
        }
    }

    async function generate() {
        const url = document.getElementById('templateSelect').value;
        if(!url) return alert("Ch·ªçn m·∫´u ƒë√£ b·ªì!");

        const data = {};
        const keys = document.querySelectorAll('.t-key');
        const vals = document.querySelectorAll('.t-val');
        keys.forEach((k, i) => data[k.value] = vals[i].value || "...");

        try {
            const res = await fetch(url);
            const zip = new PizZip(await res.arrayBuffer());
            const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
            
            doc.render(data);
            const out = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
            saveAs(out, "Ho√†n_Thi·ªán.docx");
        } catch (e) {
            alert("L·ªói: " + e.message);
        }
    }
</script>
</body>
</html>

