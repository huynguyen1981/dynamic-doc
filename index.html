<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Doc Generator - Universe Edition</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docxtemplater-image-module-free@1.1.1/build/bundle.js"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --dark: #0f172a; --accent: #8b5cf6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .guide { background: #f0f7ff; border-left: 5px solid var(--primary); padding: 15px; margin-bottom: 25px; font-size: 0.9rem; }
        .template-list { border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; max-height: 150px; overflow-y: auto; margin-bottom: 20px; }
        .main-layout { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 25px; margin-top: 25px; }
        .field-box { margin-bottom: 12px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; border-left: 4px solid var(--primary); }
        .img-box { border-left-color: var(--accent); background: #fdfaff; }
        .label { display: block; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin-bottom: 8px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; margin-top: 10px; }
        .bg-blue { background: var(--primary); color: white; }
        .bg-red { background: #ef4444; color: white; display: none; }
        .preview-pane { background: var(--dark); color: #10b981; padding: 20px; border-radius: 8px; font-family: 'Consolas', monospace; height: 100%; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Global Doc - Universe Edition</h2>
    
    <div class="guide">
        <h4>Universe Mode Active:</h4>
        <p>‚Ä¢ <b>Text Tags:</b> Use {name} for text. (D√πng {name} cho vƒÉn b·∫£n)</p>
        <p>‚Ä¢ <b>Auto Image Mapper:</b> Use {%logo}, {%sig}... for images. System will auto-create upload buttons! (D√πng {%t√™n_·∫£nh} ƒë·ªÉ t·ª± t·∫°o n√∫t upload!)</p>
    </div>

    <strong>Step 1: Choose Templates</strong>
    <div class="template-list" id="templateList">Loading...</div>
    <button class="btn-main bg-blue" onclick="scanAll()">üîç ANALYZE TEMPLATES</button>
    <div id="status" style="text-align:center; margin:10px; font-weight:bold;"></div>

    <div class="main-layout" id="formArea" style="display: none;">
        <div class="input-section">
            <strong>Step 2: Dynamic Inputs</strong>
            <div id="imageFields"></div>
            <div id="textFields"></div>
        </div>
        <div class="preview-section">
            <div class="preview-pane">
                <span style="color: #f59e0b;">DATA MAPPING PREVIEW</span>
                <hr style="border-color: #334155; margin: 10px 0;">
                <pre id="previewData">{}</pre>
            </div>
            <button class="btn-main bg-red" id="zipBtn" onclick="generateZip()">üì¶ DOWNLOAD ALL AS ZIP</button>
        </div>
    </div>
</div>

<script>
    let dynamicImages = {}; // Kho ch·ª©a d·ªØ li·ªáu ·∫£nh theo tag name

    function checkSafety() {
        if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined') {
            alert("Waiting for libraries..."); location.reload(); return false;
        }
        return true;
    }

    async function init() {
        try {
            const res = await fetch('templates.json');
            const data = await res.json();
            document.getElementById('templateList').innerHTML = data.map(t => `
                <label style="display:block; cursor:pointer; padding:5px;">
                    <input type="checkbox" class="tpl-check" value="${t.url}" data-name="${t.name}"> ${t.name}
                </label>
            `).join('');
        } catch (e) { console.error("Missing templates.json"); }
    }

    async function scanAll() {
        if (!checkSafety()) return;
        const checked = document.querySelectorAll('.tpl-check:checked');
        if(checked.length === 0) return alert("Select templates!");
        
        const textTags = new Set();
        const imgTags = new Set();
        document.getElementById('status').innerText = "‚è≥ Scanning universe...";

        for (let input of checked) {
            const res = await fetch(input.value);
            const zip = new PizZip(await res.arrayBuffer());
            const content = zip.files["word/document.xml"].asText();
            const matches = content.match(/\{([^{}]+)\}/g) || [];
            matches.forEach(m => {
                let t = m.replace(/<[^>]+>/g, "").replace(/[{}]/g, "").trim();
                if(t.startsWith('%')) imgTags.add(t.substring(1)); // B·ªè d·∫•u % ƒë·ªÉ l·∫•y t√™n
                else textTags.add(t);
            });
        }

        // T·∫°o giao di·ªán cho ·∫¢nh
        const imgContainer = document.getElementById('imageFields');
        imgContainer.innerHTML = imgTags.size > 0 ? "<b>Images Detected:</b>" : "";
        imgTags.forEach(tag => {
            imgContainer.innerHTML += `
                <div class="field-box img-box">
                    <label class="label">Upload: ${tag.toUpperCase()}</label>
                    <input type="file" accept="image/*" onchange="storeImage('${tag}', this)">
                </div>`;
        });

        // T·∫°o giao di·ªán cho Ch·ªØ
        const txtContainer = document.getElementById('textFields');
        txtContainer.innerHTML = "<b>Text Data:</b>";
        textTags.forEach(t => {
            let val = (t.toUpperCase() === "DATE") ? new Date().toLocaleDateString('en-US') : "";
            txtContainer.innerHTML += `
                <div class="field-box">
                    <label class="label">${t}</label>
                    <input type="hidden" class="t-key" value="${t}">
                    <input type="text" class="t-val" value="${val}" oninput="updateUI()">
                </div>`;
        });

        document.getElementById('formArea').style.display = "grid";
        document.getElementById('zipBtn').style.display = "block";
        document.getElementById('status').innerText = "‚úÖ Analysis complete!";
        updateUI();
    }

    function storeImage(tag, input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            dynamicImages[tag] = e.target.result;
            updateUI();
        };
        reader.readAsArrayBuffer(file);
    }

    function updateUI() {
        const data = { _images_uploaded: Object.keys(dynamicImages) };
        document.querySelectorAll('.t-key').forEach((k, i) => {
            data[k.value] = document.querySelectorAll('.t-val')[i].value || "";
        });
        document.getElementById('previewData').innerText = JSON.stringify(data, null, 4);
    }

    async function generateZip() {
        // 1. Ki·ªÉm tra b·∫£o hi·ªÉm th∆∞ vi·ªán
        if (typeof PizZip === 'undefined') {
            alert("PizZip library missing! Please refresh.");
            return;
        }
    
        // 2. X√°c ƒë·ªãnh ƒë√∫ng t√™n th∆∞ vi·ªán Image Module (B·∫£n Free th∆∞·ªùng d√πng t√™n n√†y)
        const ImageModule = window.DocxtemplaterImageModuleV2 || window.ImageModule;
        
        if (!ImageModule) {
            alert("Image library not loaded yet. Please wait 3s and try again!");
            return;
        }
    
        const checked = document.querySelectorAll('.tpl-check:checked');
        if (checked.length === 0) return alert("Please select templates!");
    
        const zipOutput = new JSZip();
        const data = JSON.parse(document.getElementById('previewData').innerText);
    
        // 3. C·∫•u h√¨nh Module ·∫£nh
        const imgOpts = {
            getImage: function(tagValue) { 
                return dynamicImages[tagValue]; 
            },
            getSize: function(img, tagValue) {
                // T·ª± ƒë·ªông ch·ªânh size d·ª±a tr√™n t√™n tag
                if(tagValue.toLowerCase().includes('logo')) return [120, 120]; // Logo vu√¥ng
                return [150, 60]; // Ch·ªØ k√Ω n·∫±m ngang
            }
        };
    
        document.getElementById('status').innerText = "‚è≥ Generating ZIP bundle...";
    
        try {
            const imgModule = new ImageModule(imgOpts); // Fix l·ªói Constructor ·ªü ƒë√¢y
    
            for (let input of checked) {
                const res = await fetch(input.value);
                if (!res.ok) throw new Error(`File not found: ${input.value}`);
                
                const pZip = new PizZip(await res.arrayBuffer());
                
                // Kh·ªüi t·∫°o docxtemplater v·ªõi module ·∫£nh
                const doc = new window.docxtemplater(pZip, { 
                    modules: [imgModule],
                    paragraphLoop: true,
                    linebreaks: true 
                });
    
                doc.render(data);
                
                const out = doc.getZip().generate({ type: "blob" });
                zipOutput.file(`${input.getAttribute('data-name')}.docx`, out);
            }
    
            const finalZip = await zipOutput.generateAsync({ type: "blob" });
            saveAs(finalZip, `Global_Bundle_${Date.now()}.zip`);
            document.getElementById('status').innerText = "üöÄ Success! Bundle downloaded.";
        } catch (e) {
            console.error(e);
            alert("L·ªói r·ªìi b·ªì ∆°i: " + e.message);
            document.getElementById('status').innerText = "‚ùå Error occurred.";
        }
    }
    window.onload = init;
</script>
</body>
</html>


