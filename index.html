<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Global Doc Pro - Image Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docxtemplater-image-module-free@1.1.1/build/bundle.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .tpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .tpl-item { border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; display: flex; align-items: center; cursor: pointer; }
        .tpl-item input { margin-right: 10px; }
        .field-box { margin-bottom: 15px; background: #f1f5f9; padding: 15px; border-radius: 8px; }
        label { display: block; font-weight: bold; font-size: 0.8rem; color: #64748b; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-p { background: var(--p); }
        #status { text-align: center; margin: 15px; color: var(--p); font-weight: bold; }
        pre { background: #1e293b; color: #10b981; padding: 15px; border-radius: 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìÑ H·ªì S∆° Pro - T·ª± ƒê·ªông Ch√®n ·∫¢nh</h2>
    <div class="tpl-grid" id="tplList">ƒêang t·∫£i...</div>
    <button class="btn btn-p" onclick="scan()">üîç QU√âT TAGS</button>
    <div id="status">S·∫µn s√†ng</div>

    <div id="main" style="display:none">
        <div id="inputs"></div>
        <pre id="preview">{}</pre>
        <button class="btn" style="background:#059669" onclick="build()">üì¶ XU·∫§T FILE ZIP</button>
    </div>
</div>

<script>
    let rawImages = {}; // L∆∞u tr·ªØ d·ªØ li·ªáu ·∫£nh

    async function init() {
        const res = await fetch('templates.json');
        const data = await res.json();
        document.getElementById('tplList').innerHTML = data.map(t => `
            <label class="tpl-item"><input type="checkbox" class="chk" value="${t.url}" data-name="${t.name}">${t.name}</label>
        `).join('');
    }

    async function scan() {
        const checked = document.querySelectorAll('.chk:checked');
        if(!checked.length) return alert("Ch·ªçn m·∫´u ƒë√£ b·ªì!");
        
        const tags = { text: new Set(), img: new Set() };
        for(let c of checked) {
            const res = await fetch(c.value);
            const zip = new PizZip(await res.arrayBuffer());
            const content = zip.files["word/document.xml"].asText();
            const matches = content.match(/\{([^{}]+)\}/g) || [];
            matches.forEach(m => {
                let t = m.replace(/[{}]/g, "").trim();
                if(t.startsWith('%')) tags.img.add(t.substring(1));
                else tags.text.add(t);
            });
        }
        render(tags);
    }

    function render(tags) {
        const div = document.getElementById('inputs');
        div.innerHTML = "";
        tags.img.forEach(t => div.innerHTML += `<div class="field-box"><label>üì∑ ·∫¢NH: ${t}</label><input type="file" onchange="saveFile('${t}', this)"></div>`);
        tags.text.forEach(t => div.innerHTML += `<div class="field-box"><label>‚úçÔ∏è CH·ªÆ: ${t}</label><input type="text" class="v" data-tag="${t}" oninput="up()"></div>`);
        document.getElementById('main').style.display = "block";
    }

    // Chuy·ªÉn ·∫£nh sang ArrayBuffer ƒë·ªÉ Docxtemplater ƒë·ªçc
    function saveFile(tag, input) {
        const reader = new FileReader();
        reader.onload = (e) => { rawImages[tag] = e.target.result; up(); };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function up() {
        const data = {};
        document.querySelectorAll('.v').forEach(i => data[i.dataset.tag] = i.value);
        document.getElementById('preview').innerText = JSON.stringify(data, null, 4);
    }

    async function build() {
        const zipOut = new JSZip();
        const data = JSON.parse(document.getElementById('preview').innerText);
        const checked = document.querySelectorAll('.chk:checked');

        // C·∫§U H√åNH IMAGE MODULE
        const ImageModule = window.DocxtemplaterImageModuleV2 || window.ImageModule;
        const imgOptions = new ImageModule({
            getImage: (tag) => rawImages[tag],
            getSize: () => [150, 60] // K√≠ch th∆∞·ªõc m·∫∑c ƒë·ªãnh cho ·∫£nh/ch·ªØ k√Ω
        });

        try {
            for(let c of checked) {
                const res = await fetch(c.value);
                const doc = new window.docxtemplater(new PizZip(await res.arrayBuffer()), {
                    modules: [imgOptions] // N·∫°p module ·∫£nh v√†o ƒë√¢y
                });
                doc.render(data);
                zipOut.file(`${c.dataset.name}.docx`, doc.getZip().generate({type:"blob"}));
            }
            saveAs(await zipOut.generateAsync({type:"blob"}), `HoSo_Final.zip`);
        } catch(e) { alert("L·ªói: " + e.message); }
    }
    window.onload = init;
</script>
</body>
</html>
