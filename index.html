<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DYNAMIC DOCS</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>

    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #1a1d21; --warning: #ffc107; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        
        .toolbar { margin-bottom: 10px; display: flex; gap: 10px; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; background: #fff; }

        .template-list { border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; max-height: 150px; overflow-y: auto; margin-bottom: 20px; }
        .tpl-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f8f9fa; cursor: pointer; }
        
        /* Layout */
        .main-layout { display: flex; gap: 25px; margin-top: 20px; flex-wrap: wrap; }
        .input-section { flex: 1.2; min-width: 350px; }
        .preview-section { flex: 0.8; min-width: 300px; background: var(--dark); color: #fff; padding: 20px; border-radius: 10px; height: fit-content; position: sticky; top: 20px; }
        
        .field-box { background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #dee2e6; border-left: 5px solid var(--primary); transition: 0.3s; }
        .field-box.empty { border-left-color: var(--danger); background: #fff5f5; }
        
        .label { font-weight: bold; font-size: 0.85rem; color: #495057; display: block; margin-bottom: 6px; }
        .input-tag { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        textarea.input-tag { resize: vertical; min-height: 60px; }

        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 1rem; margin-top: 10px; }
        .bg-scan { background: var(--success); }
        .bg-zip { background: var(--danger); display: none; }
        
        #status { text-align: center; margin: 15px; font-weight: bold; color: var(--primary); }
        .warning-text { color: var(--warning); font-size: 0.8rem; font-weight: bold; display: none; margin-top: 5px; }
        
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 0.85rem; color: #00ff00; }
        #qrcode { background: white; padding: 10px; margin-top: 15px; display: inline-block; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìÑ Global Project Document System</h2>
    
    <div class="toolbar">
        <button class="btn-small" onclick="toggleAll(true)">‚úÖ Select All</button>
        <button class="btn-small" onclick="toggleAll(false)">‚ùå Deselect</button>
    </div>
    <div id="templateList" class="template-list">Connecting...</div>
    
    <button class="btn-main bg-scan" onclick="scanAll()">üîç ANALYZE TEMPLATES</button>
    <div id="status"></div>

    <div class="main-layout" id="formArea" style="display: none;">
        <div class="input-section">
            <div id="fields"></div>
        </div>
        <div class="preview-section">
            <span style="color: #ffc107; font-weight: bold;">LIVE DATA PREVIEW</span>
            <hr>
            <pre id="previewData">{}</pre>
            <div style="margin-top:20px;">
                <span style="font-size: 0.8rem; color: #aaa;">AUTOMATIC QR CODE:</span><br>
                <div id="qrcode"></div>
            </div>
            <button class="btn-main bg-zip" id="zipBtn" onclick="generateZip()">üì¶ EXPORT ALL (.ZIP)</button>
        </div>
    </div>
</div>

<script>
    function checkLib() {
        if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined') {
            alert("Library loading... please wait 2s!");
            location.reload(); return false;
        }
        return true;
    }

    if (window.firebaseConfig) firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();
    let qrcodeGenerator = null;

    db.collection("templates").onSnapshot(snap => {
        const list = document.getElementById('templateList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            list.innerHTML += `<label class="tpl-item"><input type="checkbox" class="tpl-check" value="${d.url}" data-name="${d.name}"> &nbsp; ${d.name}</label>`;
        });
    });

    function toggleAll(s) { document.querySelectorAll('.tpl-check').forEach(el => el.checked = s); }

    async function scanAll() {
        if (!checkLib()) return;
        const checked = document.querySelectorAll('.tpl-check:checked');
        if(checked.length === 0) return alert("Select at least 1 template!");
        
        const status = document.getElementById('status');
        const container = document.getElementById('fields');
        status.innerText = "Analyzing tags...";
        
        const allTags = new Set();
        try {
            for (let input of checked) {
                const res = await fetch(input.value);
                const zip = new PizZip(await res.arrayBuffer());
                const content = zip.files["word/document.xml"].asText();
                const regex = /\{([^{}]+)\}/g;
                let m;
                while ((m = regex.exec(content)) !== null) {
                    let t = m[1].replace(/<[^>]+>/g, "").trim();
                    if(t) allTags.add(t);
                }
            }

            container.innerHTML = "<strong>Input Data:</strong><br><br>";
            allTags.forEach(t => {
                // S·ª≠ d·ª•ng textarea cho c√°c tag d√†i (c√≥ t·ª´ DESCRIP ho·∫∑c NOTE)
                const isLong = t.toUpperCase().includes("DESCRIP") || t.toUpperCase().includes("NOTE");
                const inputHtml = isLong 
                    ? `<textarea class="input-tag t-val" oninput="updateUI(this)" placeholder="Enter ${t}..."></textarea>`
                    : `<input type="text" class="input-tag t-val" oninput="updateUI(this)" placeholder="Enter ${t}...">`;

                container.innerHTML += `
                    <div class="field-box">
                        <span class="label">${t}</span>
                        <input type="hidden" class="t-key" value="${t}">
                        ${inputHtml}
                        <span class="warning-text">‚ö†Ô∏è This field is required!</span>
                    </div>`;
            });

            document.getElementById('formArea').style.display = "flex";
            document.getElementById('zipBtn').style.display = "block";
            status.innerText = "Analysis complete!";
            updateUI();
        } catch (e) { status.innerText = "Error: " + e.message; }
    }

    function updateUI(el) {
        if(el) {
            const box = el.closest('.field-box');
            if(!el.value.trim()) {
                box.classList.add('empty');
                box.querySelector('.warning-text').style.display = 'block';
            } else {
                box.classList.remove('empty');
                box.querySelector('.warning-text').style.display = 'none';
            }
        }
        
        const data = {};
        document.querySelectorAll('.t-key').forEach((k, i) => {
            data[k.value] = document.querySelectorAll('.t-val')[i].value || "";
        });
        document.getElementById('previewData').innerText = JSON.stringify(data, null, 4);

        // C·∫≠p nh·∫≠t QR Code (D·∫´n v·ªÅ link h·ªì s∆° ho·∫∑c ƒë·ªãnh danh)
        const qrContent = "Project_ID_" + new Date().toLocaleDateString();
        const qrDiv = document.getElementById("qrcode");
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: qrContent, width: 80, height: 80 });
    }

    async function generateZip() {
        const checked = document.querySelectorAll('.tpl-check:checked');
        const zipOutput = new JSZip();
        const data = JSON.parse(document.getElementById('previewData').innerText);

        // Ki·ªÉm tra xem c√≤n √¥ n√†o tr·ªëng kh√¥ng
        let hasEmpty = false;
        document.querySelectorAll('.t-val').forEach(el => {
            if(!el.value.trim()) {
                el.closest('.field-box').classList.add('empty');
                hasEmpty = true;
            }
        });
        if(hasEmpty) return alert("Please fill in all required fields (Red boxes)!");

        document.getElementById('status').innerText = "Zipping documents...";
        try {
            for (let input of checked) {
                const res = await fetch(input.value);
                const pZip = new PizZip(await res.arrayBuffer());
                const doc = new window.docxtemplater(pZip, { paragraphLoop: true, linebreaks: true });
                doc.render(data);
                const out = doc.getZip().generate({ type: "blob" });
                zipOutput.file(`${input.getAttribute('data-name')}.docx`, out);
            }
            const zipBlob = await zipOutput.generateAsync({ type: "blob" });
            saveAs(zipBlob, `Project_Bundle_${new Date().getTime()}.zip`);
            document.getElementById('status').innerText = "Exported Successfully!";
        } catch (e) { alert("Error: " + e.message); }
    }
</script>
</body>
</html>
