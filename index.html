<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Doc Pro - Triple Safety Edition</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docxtemplater-image-module-free@1.1.1/build/bundle.js"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --dark: #0f172a; --accent: #8b5cf6; --green: #10b981; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .guide { background: #f0f7ff; border-left: 5px solid var(--primary); padding: 15px; margin-bottom: 25px; border-radius: 4px; font-size: 0.85rem; }
        .template-list { border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; max-height: 150px; overflow-y: auto; margin-bottom: 20px; }
        .main-layout { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 25px; margin-top: 25px; }
        .field-box { margin-bottom: 12px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; border-left: 4px solid var(--primary); }
        .date-box { border-left-color: var(--green); background: #f0fdf4; }
        .img-box { border-left-color: var(--accent); background: #fdfaff; }
        .label { display: block; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin-bottom: 8px; }
        input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .bg-blue { background: var(--primary); color: white; }
        .bg-red { background: #ef4444; color: white; display: none; }
        .preview-pane { background: var(--dark); color: #10b981; padding: 20px; border-radius: 8px; font-family: 'Consolas', monospace; overflow-x: auto; }
        #status { text-align: center; margin: 15px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Global Doc Pro - Secure Edition</h2>
    
    <div class="guide">
        <h4 style="margin:0">üõ†Ô∏è Tag Rules:</h4>
        <code>{NAME}</code> (Text) | <code>{d%BIRTHDAY}</code> (Calendar) | <code>{%LOGO}</code> (Image)
    </div>

    <strong>Step 1: Choose Templates</strong>
    <div class="template-list" id="templateList">Loading...</div>
    <button class="btn-main bg-blue" id="scanBtn" onclick="scanAll()">üîç ANALYZE TEMPLATES</button>
    <div id="status">Waiting for libraries...</div>

    <div class="main-layout" id="formArea" style="display: none;">
        <div id="inputs">
            <div id="imageFields"></div>
            <div id="dateFields"></div>
            <div id="textFields"></div>
        </div>
        <div class="preview-section">
            <div class="preview-pane"><pre id="previewData">{}</pre></div>
            <button class="btn-main bg-red" id="zipBtn" onclick="generateZip()">üì¶ DOWNLOAD (.ZIP)</button>
        </div>
    </div>
</div>

<script>
    let dynamicImages = {};

    // --- KH√ìA B·∫¢O HI·ªÇM T·ªîNG L·ª∞C (MAX SECURITY) ---
    function checkLibs() {
        const ImgMod = window.DocxtemplaterImageModuleV2 || window.ImageModule;
        // Ki·ªÉm tra ƒë·ªß b·ªô 4 nguy√™n t·ª≠: PizZip, JSZip, Docxtemplater, ImageModule
        return (typeof PizZip !== 'undefined' && typeof JSZip !== 'undefined' && typeof window.docxtemplater !== 'undefined' && ImgMod);
    }

    function runWithSafety(callback) {
        if (checkLibs()) {
            callback(window.DocxtemplaterImageModuleV2 || window.ImageModule);
        } else {
            document.getElementById('status').innerText = "‚ö†Ô∏è Libraries loading... Please wait.";
            setTimeout(() => runWithSafety(callback), 500); // Polling m·ªói 0.5s
        }
    }

    async function init() {
        try {
            const res = await fetch('templates.json');
            const data = await res.json();
            document.getElementById('templateList').innerHTML = data.map(t => `
                <label style="display:block; padding:5px;"><input type="checkbox" class="tpl-check" value="${t.url}" data-name="${t.name}"> ${t.name}</label>
            `).join('');
            document.getElementById('status').innerText = "‚úÖ Systems ready.";
        } catch (e) { document.getElementById('status').innerText = "JSON Error!"; }
    }

    async function scanAll() {
        runWithSafety(async () => {
            const checked = document.querySelectorAll('.tpl-check:checked');
            if(checked.length === 0) return alert("Select templates!");
            
            const textTags = new Set(), imgTags = new Set(), dateTags = new Set();
            document.getElementById('status').innerText = "‚è≥ Scanning...";

            for (let input of checked) {
                const res = await fetch(input.value);
                const zip = new PizZip(await res.arrayBuffer());
                const content = zip.files["word/document.xml"].asText();
                const matches = content.match(/\{([^{}]+)\}/g) || [];
                matches.forEach(m => {
                    let t = m.replace(/<[^>]+>/g, "").replace(/[{}]/g, "").trim();
                    if(t.startsWith('%')) imgTags.add(t.substring(1));
                    else if(t.startsWith('d%')) dateTags.add(t);
                    else textTags.add(t);
                });
            }

            renderFields('imageFields', imgTags, 'img-box', 'file');
            renderFields('dateFields', dateTags, 'date-box', 'date');
            renderFields('textFields', textTags, '', 'text');
            
            document.getElementById('formArea').style.display = "grid";
            document.getElementById('zipBtn').style.display = "block";
            document.getElementById('status').innerText = "‚úÖ Form Generated.";
            updateUI();
        });
    }

    function renderFields(id, tags, css, type) {
        const container = document.getElementById(id);
        container.innerHTML = tags.size > 0 ? `<div style='margin:10px 0; font-weight:bold;'>${id.replace('Fields','')}</div>` : "";
        tags.forEach(t => {
            let label = t.startsWith('d%') ? t.substring(2) : t;
            container.innerHTML += `<div class="field-box ${css}"><label class="label">${label}</label>
                <input type="${type}" class="t-val" data-tag="${t}" oninput="updateUI()" 
                ${type==='file' ? `onchange="saveImg('${t}',this)"` : (type==='date' ? `value="${new Date().toISOString().split('T')[0]}"` : '')}></div>`;
        });
    }

    function saveImg(tag, input) {
        const reader = new FileReader();
        reader.onload = (e) => { dynamicImages[tag] = e.target.result; updateUI(); };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function updateUI() {
        const data = {};
        document.querySelectorAll('.t-val').forEach(i => {
            let tag = i.getAttribute('data-tag');
            if (i.type === 'date') {
                const [y, m, d] = i.value.split('-');
                data[tag] = `${m}/${d}/${y}`;
            } else if (i.type !== 'file') data[tag] = i.value;
        });
        document.getElementById('previewData').innerText = JSON.stringify(data, null, 4);
    }

    async function generateZip() {
        runWithSafety(async (ImgModClass) => {
            const checked = document.querySelectorAll('.tpl-check:checked');
            const zipOutput = new JSZip();
            const data = JSON.parse(document.getElementById('previewData').innerText);

            try {
                const imgModule = new ImgModClass({
                    getImage: (tag) => dynamicImages[tag],
                    getSize: (img, tag) => tag.toLowerCase().includes('logo') ? [120, 120] : [150, 60]
                });

                for (let input of checked) {
                    const res = await fetch(input.value);
                    const doc = new window.docxtemplater(new PizZip(await res.arrayBuffer()), { modules: [imgModule] });
                    doc.render(data);
                    zipOutput.file(`${input.getAttribute('data-name')}.docx`, doc.getZip().generate({type:"blob"}));
                }
                saveAs(await zipOutput.generateAsync({type:"blob"}), `Bundle_${Date.now()}.zip`);
                document.getElementById('status').innerText = "üöÄ Done!";
            } catch (e) { alert(e.message); }
        });
    }
    window.onload = init;
</script>
</body>
</html>
