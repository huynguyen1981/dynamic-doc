<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Doc Generator Pro - Fixed Layout</title>
    
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --s: #059669; --bg: #f8fafc; --gray: #64748b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        /* Gi·ªØ giao di·ªán chuy√™n nghi·ªáp */
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; }
        .card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .tpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tpl-item { display: flex; align-items: center; padding: 12px 15px; border: 1px solid #f1f5f9; border-radius: 8px; cursor: pointer; }
        
        /* FIX CH·ªñ N√ÄY: Chia l·∫°i t·ªâ l·ªá ƒë·ªÉ √¥ nh·∫≠p li·ªáu r·ªông r√£i h∆°n */
        .work-area { display: grid; grid-template-columns: 1fr 400px; gap: 30px; border-top: 2px solid #f1f5f9; padding-top: 30px; }
        
        .field-box { margin-bottom: 18px; }
        .field-box label { display: block; font-weight: 600; font-size: 0.8rem; color: var(--gray); margin-bottom: 6px; }
        .input-control { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 0.95rem; }
        textarea.input-control { min-height: 120px; resize: vertical; }

        /* FIX CH·ªñ N√ÄY: Preview kh√¥ng bao gi·ªù tr√†n */
        .preview-pane { 
            background: #0f172a; 
            border-radius: 12px; 
            padding: 15px; 
            color: #34d399; 
            font-family: 'Fira Code', monospace; 
            font-size: 0.8rem;
            position: sticky; /* Cu·ªôn trang th√¨ n√≥ v·∫´n n·∫±m im cho d·ªÖ nh√¨n */
            top: 20px;
        }
        
        #jsonOut { 
            white-space: pre-wrap;       /* Quan tr·ªçng: T·ª± xu·ªëng d√≤ng khi text qu√° d√†i */
            word-wrap: break-word;       /* Quan tr·ªçng: Ng·∫Øt t·ª´ n·∫øu t·ª´ qu√° d√†i */
            max-height: 500px;           /* Kh·ªëng ch·∫ø chi·ªÅu cao t·ªëi ƒëa */
            overflow-y: auto;            /* Hi·ªán thanh cu·ªôn d·ªçc n·∫øu c·∫ßn */
            margin: 0;
        }

        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; margin-top: 20px; display: none; }
        #status { text-align: center; margin: 20px 0; font-weight: 600; color: var(--p); }

        @media (max-width: 900px) {
            .work-area { grid-template-columns: 1fr; }
            .preview-pane { position: static; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Global Doc Generator Pro</h1>
    </div>

    <div class="card">
        <strong>1. Ch·ªçn m·∫´u vƒÉn b·∫£n</strong>
        <div id="tplList" class="tpl-grid" style="margin-top:15px">ƒêang ki·ªÉm tra h·ªá th·ªëng...</div>
        <button id="scanBtn" class="btn btn-p" style="margin-top:20px; opacity: 0.5;" disabled onclick="analyze()">üîç PH√ÇN T√çCH TAGS</button>
    </div>

    <div id="status">‚è≥ ƒêang ƒë·ª£i th∆∞ vi·ªán...</div>

    <div id="workZone" class="work-area" style="display: none;">
        <div>
            <strong style="display:block; margin-bottom:15px">2. Nh·∫≠p th√¥ng tin</strong>
            <div id="inputs"></div>
        </div>
        <div>
            <strong style="display:block; margin-bottom:15px">3. Preview JSON</strong>
            <div class="preview-pane">
                <pre id="jsonOut">{}</pre>
            </div>
            <button class="btn btn-s" id="zipBtn" onclick="buildZip()">üì¶ T·∫¢I B·ªò H·ªí S∆† (.ZIP)</button>
        </div>
    </div>
</div>

<script>
    // Ki·ªÉm tra th∆∞ vi·ªán
    const checkLibs = setInterval(() => {
        if (window.PizZip && window.docxtemplater) {
            clearInterval(checkLibs);
            document.getElementById('status').innerText = "‚úÖ H·ªá th·ªëng s·∫µn s√†ng!";
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('scanBtn').style.opacity = "1";
            init();
        }
    }, 500);

    async function init() {
        try {
            const res = await fetch('templates.json');
            const data = await res.json();
            document.getElementById('tplList').innerHTML = data.map(t => `
                <label class="tpl-item">
                    <input type="checkbox" class="tpl-check" value="${t.url}" data-name="${t.name}">
                    <span style="margin-left:10px">${t.name}</span>
                </label>
            `).join('');
        } catch (e) { document.getElementById('status').innerText = "L·ªói: File templates.json kh√¥ng t·ªìn t·∫°i!"; }
    }

    async function analyze() {
        const checked = document.querySelectorAll('.tpl-check:checked');
        if (!checked.length) return alert("B·ªì h√£y ch·ªçn m·∫´u!");
        
        const tags = { text: new Set(), date: new Set(), note: new Set() };
        try {
            for (let item of checked) {
                const res = await fetch(item.value);
                const zip = new window.PizZip(await res.arrayBuffer());
                const content = zip.files["word/document.xml"].asText();
                (content.match(/\{[^{}]+\}/g) || []).forEach(m => {
                    let t = m.replace(/<[^>]+>/g, "").replace(/[{}]/g, "").trim();
                    if(t.startsWith('n%')) tags.note.add(t);
                    else if(t.startsWith('d%')) tags.date.add(t);
                    else tags.text.add(t);
                });
            }
            renderInputs(tags);
        } catch (e) { alert("L·ªói ƒë·ªçc file: " + e.message); }
    }

    function renderInputs(tags) {
        const container = document.getElementById('inputs');
        container.innerHTML = "";
        tags.date.forEach(t => container.innerHTML += makeInput(t, 'date', 'üìÖ NG√ÄY TH√ÅNG'));
        tags.text.forEach(t => container.innerHTML += makeInput(t, 'text', '‚úçÔ∏è VƒÇN B·∫¢N NG·∫ÆN'));
        tags.note.forEach(t => {
            container.innerHTML += `<div class="field-box"><label>${t.substring(2)} (üìù VƒÇN B·∫¢N D√ÄI)</label>
            <textarea class="input-control t-val" data-tag="${t}" oninput="update()"></textarea></div>`;
        });
        document.getElementById('workZone').style.display = "grid";
        document.getElementById('zipBtn').style.display = "block";
        update();
    }

    function makeInput(tag, type, hint) {
        let label = tag.startsWith('d%') ? tag.substring(2) : tag;
        return `<div class="field-box"><label>${label} (${hint})</label>
        <input type="${type}" class="input-control t-val" data-tag="${tag}" oninput="update()"></div>`;
    }

    function update() {
        const data = {};
        document.querySelectorAll('.t-val').forEach(i => {
            let tag = i.dataset.tag;
            if (i.type === 'date' && i.value) {
                const [y, m, d] = i.value.split('-');
                data[tag] = `${d}/${m}/${y}`;
            } else {
                data[tag] = i.value;
            }
        });
        document.getElementById('jsonOut').innerText = JSON.stringify(data, null, 4);
    }

    async function buildZip() {
        const zipOut = new JSZip();
        const data = JSON.parse(document.getElementById('jsonOut').innerText);
        try {
            const checked = document.querySelectorAll('.tpl-check:checked');
            for (let c of checked) {
                const res = await fetch(c.value);
                const zip = new window.PizZip(await res.arrayBuffer());
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                doc.render(data);
                zipOut.file(`${c.dataset.name}.docx`, doc.getZip().generate({type:"blob"}));
            }
            saveAs(await zipOut.generateAsync({type:"blob"}), "HoSo.zip");
        } catch (e) { alert("L·ªói: " + e.message); }
    }
</script>
</body>
</html>
