<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Doc - Final Universe</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docxtemplater-image-module-free@1.1.1/build/bundle.js"></script>

    <style>
        :root { --p: #6366f1; --s: #10b981; --bg: #0f172a; --card: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #f8fafc; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid #334155; }
        
        .header h1 { margin: 0; background: linear-gradient(to right, #818cf8, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.2rem; }
        .step-box { background: #334155; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 6px solid var(--p); }
        
        .tpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .tpl-item { background: #1e293b; border: 1px solid #475569; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .tpl-item:hover { border-color: var(--p); background: #334155; }
        
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
        .field-card { background: #1e293b; padding: 15px; border-radius: 10px; border-bottom: 3px solid var(--p); margin-bottom: 10px; }
        .field-card.date { border-bottom-color: var(--s); }
        
        label { display: block; font-size: 0.75rem; color: #94a3b8; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; }
        input { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 6px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; margin-top: 10px; }
        .btn-p { background: var(--p); color: white; }
        .btn-p:hover { filter: brightness(1.2); transform: scale(1.01); }
        .btn-s { background: var(--s); color: white; display: none; }
        
        #status { color: #818cf8; font-weight: bold; text-align: center; margin: 15px 0; }
        pre { background: #0f172a; padding: 15px; border-radius: 10px; color: #34d399; font-size: 0.8rem; border: 1px solid #334155; max-height: 200px; overflow: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="header" style="text-align: center;">
        <h1>üåå FINAL UNIVERSE DOC</h1>
        <p style="color: #94a3b8;">H·ªá th·ªëng t·ª± ƒë·ªông h√≥a vƒÉn b·∫£n vƒ©nh c·ª≠u</p>
    </div>

    <div class="step-box">
        <strong>üìå B∆∞·ªõc 1: Ch·ªçn m·∫´u c·ªßa b·ªì</strong>
        <div id="tplArea" class="tpl-grid">ƒêang n·∫°p file JSON...</div>
        <button class="btn btn-p" onclick="doAnalyze()">üîç B·∫ÆT ƒê·∫¶U QU√âT M·∫™U</button>
    </div>

    <div id="status">H·ªá th·ªëng ƒë√£ s·∫µn s√†ng.</div>

    <div id="mainForm" style="display:none;">
        <div class="input-group">
            <div>
                <strong style="color:var(--p)">üìù B∆∞·ªõc 2: Nh·∫≠p li·ªáu</strong>
                <div id="fields" style="margin-top:15px;"></div>
            </div>
            <div>
                <strong style="color:var(--s)">üìã Xem tr∆∞·ªõc d·ªØ li·ªáu</strong>
                <pre id="jsonPreview">{}</pre>
                <button class="btn btn-s" id="zipBtn" onclick="doGenerate()">üì¶ T·∫¢I B·ªò FILE ZIP (.ZIP)</button>
            </div>
        </div>
    </div>
</div>

<script>
    let imgData = {};
    const status = document.getElementById('status');

    // Kh·ªüi t·∫°o l·∫•y file JSON
    async function init() {
        try {
            const res = await fetch('templates.json');
            const data = await res.json();
            document.getElementById('tplArea').innerHTML = data.map(t => `
                <label class="tpl-item">
                    <input type="checkbox" class="tpl-check" value="${t.url}" data-name="${t.name}">
                    <span>${t.name}</span>
                </label>
            `).join('');
        } catch (e) { status.innerText = "‚ùå Kh√¥ng t√¨m th·∫•y templates.json!"; }
    }

    // H√†m qu√©t m·∫´u
    async function doAnalyze() {
        const checks = document.querySelectorAll('.tpl-check:checked');
        if (checks.length === 0) return alert("B·ªì ch·ªçn m·∫´u ƒë√£!");

        status.innerText = "‚è≥ ƒêang ph√¢n t√≠ch m·∫´u...";
        const tags = { text: new Set(), img: new Set(), date: new Set() };

        try {
            for (let c of checks) {
                const res = await fetch(c.value);
                const zip = new PizZip(await res.arrayBuffer());
                const content = zip.files["word/document.xml"].asText();
                const matches = content.match(/\{([^{}]+)\}/g) || [];
                
                matches.forEach(m => {
                    let t = m.replace(/<[^>]+>/g, "").replace(/[{}]/g, "").trim();
                    if(t.startsWith('%')) tags.img.add(t.substring(1));
                    else if(t.startsWith('d%')) tags.date.add(t);
                    else tags.text.add(t);
                });
            }
            renderInputs(tags);
            status.innerText = "‚úÖ ƒê√£ qu√©t xong!";
        } catch (e) { status.innerText = "‚ùå L·ªói file: " + e.message; }
    }

    function renderInputs(tags) {
        const f = document.getElementById('fields');
        f.innerHTML = "";
        
        tags.img.forEach(t => f.innerHTML += makeInput(t, 'image', 'file'));
        tags.date.forEach(t => f.innerHTML += makeInput(t, 'date', 'date'));
        tags.text.forEach(t => f.innerHTML += makeInput(t, 'text', 'text'));

        document.getElementById('mainForm').style.display = "grid";
        document.getElementById('zipBtn').style.display = "block";
        updateJSON();
    }

    function makeInput(tag, cls, type) {
        let label = tag.startsWith('d%') ? tag.substring(2) : tag;
        let evt = type === 'file' ? `onchange="readImg('${tag}', this)"` : `oninput="updateJSON()"`;
        let val = type === 'date' ? new Date().toISOString().split('T')[0] : "";
        return `<div class="field-card ${cls}"><label>${label}</label>
                <input type="${type}" class="t-val" data-tag="${tag}" value="${val}" ${evt}></div>`;
    }

    function readImg(tag, input) {
        const reader = new FileReader();
        reader.onload = (e) => { imgData[tag] = e.target.result; updateJSON(); };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function updateJSON() {
        const data = {};
        document.querySelectorAll('.t-val').forEach(i => {
            let tag = i.getAttribute('data-tag');
            if (i.type === 'date') {
                const [y, m, d] = i.value.split('-');
                data[tag] = `${m}/${d}/${y}`;
            } else if (i.type !== 'file') data[tag] = i.value;
        });
        document.getElementById('jsonPreview').innerText = JSON.stringify(data, null, 4);
    }

    async function doGenerate() {
        status.innerText = "‚è≥ ƒêang t·∫°o ZIP...";
        const ImgMod = window.DocxtemplaterImageModuleV2 || window.ImageModule;
        const checks = document.querySelectorAll('.tpl-check:checked');
        const zipOut = new JSZip();
        const data = JSON.parse(document.getElementById('jsonPreview').innerText);

        try {
            const opts = new ImgMod({
                getImage: (t) => imgData[t],
                getSize: (i, t) => t.toLowerCase().includes('logo') ? [120, 120] : [150, 60]
            });

            for (let c of checks) {
                const res = await fetch(c.value);
                const doc = new window.docxtemplater(new PizZip(await res.arrayBuffer()), { modules: [opts] });
                doc.render(data);
                zipOut.file(`${c.getAttribute('data-name')}.docx`, doc.getZip().generate({type:"blob"}));
            }
            saveAs(await zipOut.generateAsync({type:"blob"}), `Global_Package.zip`);
            status.innerText = "üöÄ Th√†nh c√¥ng r·ª±c r·ª°!";
        } catch (e) { alert("L·ªói xu·∫•t file: " + e.message); }
    }
    window.onload = init;
</script>
</body>
</html>
