<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B·∫£n Ch·ªët Cu·ªëi - Ki·ªÉm Tra ·∫¢nh</title>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.21.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; text-align: center; }
        .box { background: white; padding: 20px; border-radius: 10px; display: inline-block; text-align: left; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 400px; }
        #debug { margin-top: 15px; font-size: 11px; color: #666; background: #eee; padding: 10px; text-align: left; max-height: 150px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="box">
    <h3>üõ† C·ª©u V√£n T√¨nh Th·∫ø</h3>
    <input type="file" id="w" accept=".docx"> <br>
    <input type="file" id="x" accept=".xlsx"> <br>
    <input type="file" id="i" multiple accept="image/*">
    <div id="debug">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c n·∫°p...</div>
    <button onclick="run()" style="width:100%; padding:10px; background:blue; color:white; margin-top:10px;">XU·∫§T FILE</button>
</div>

<script>
    let imgs = {};
    document.getElementById('i').onchange = (e) => {
        imgs = {};
        const names = [];
        Array.from(e.target.files).forEach(f => {
            names.push(f.name);
            const r = new FileReader();
            r.onload = (ev) => { imgs[f.name] = ev.target.result; };
            r.readAsArrayBuffer(f);
        });
        document.getElementById('debug').innerText = "ƒê√£ n·∫°p ·∫£nh:\n" + names.join("\n");
    };

    async function run() {
        try {
            const fW = document.getElementById('w').files[0];
            const fX = document.getElementById('x').files[0];
            if(!fW || !fX) return alert("Thi·∫øu file!");

            const xB = await fX.arrayBuffer();
            const data = XLSX.utils.sheet_to_json(XLSX.read(xB).Sheets[XLSX.read(xB).SheetNames[0]]);

            const zip = new window.PizZip(await fW.arrayBuffer());
            const doc = new window.docxtemplater();
            doc.loadZip(zip);

            const imgMod = new window.ImageModule({
                getImage: (name) => {
                    if (!imgs[name]) {
                        console.error("Kh√¥ng th·∫•y ·∫£nh: " + name);
                        return null; 
                    }
                    return imgs[name];
                },
                getSize: () => [300, 200]
            });
            doc.attachModule(imgMod);

            // ƒê·ªî D·ªÆ LI·ªÜU PH·∫≤NG (D√πng d√≤ng ƒë·∫ßu ti√™n c·ªßa Excel ƒë·ªÉ test)
            // Word ch·ªâ c·∫ßn g√µ: {TEN} v√† {%HINH_ANH} (kh√¥ng c·∫ßn rows)
            doc.setData(data[0]); 

            doc.render();
            saveAs(doc.getZip().generate({type: "blob"}), "Test_Thoi.docx");
            alert("ƒê√£ xu·∫•t! N·∫øu file c√≥ ch·ªØ m√† kh√¥ng c√≥ h√¨nh, b·ªì ki·ªÉm tra l·∫°i t√™n file ·∫£nh trong debug nh√©!");

        } catch (e) {
            console.error(e);
            alert("L·ªói: " + e.message);
        }
    }
</script>
</body>
</html>
