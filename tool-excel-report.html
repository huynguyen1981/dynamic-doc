<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Excel to Word Report - Stable Version</title>
    
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --s: #10b981; --bg: #f1f5f9; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); padding: 40px; color: #1e293b; }
        .box { max-width: 650px; margin: auto; background: white; padding: 35px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--p); margin-top: 0; }
        .input-group { margin-bottom: 20px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; transition: 0.3s; }
        .input-group:hover { border-color: var(--p); background: #f8fafc; }
        label { display: block; font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: #475569; }
        input[type="file"] { width: 100%; font-size: 0.85rem; }
        .btn { width: 100%; padding: 15px; background: var(--p); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; margin-top: 10px; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; display: none; }
        .success { background: #dcfce7; color: #166534; display: block !important; }
        .error { background: #fee2e2; color: #991b1b; display: block !important; }
        .loading { background: #e0f2fe; color: #075985; display: block !important; }
    </style>
</head>
<body>

<div class="box">
    <h2>üöÄ B√°o C√°o Kh·∫£o S√°t T·ª± ƒê·ªông</h2>
    <p style="text-align: center; font-size: 0.85rem; color: #64748b; margin-bottom: 30px;">
        H·ª£p nh·∫•t Excel & H√¨nh ·∫£nh v√†o duy nh·∫•t 1 file Word
    </p>
    
    <div class="input-group">
        <label>1. M·∫´u Word ({#rows}...{%HINH_ANH}...{/rows})</label>
        <input type="file" id="tpl" accept=".docx">
    </div>

    <div class="input-group">
        <label>2. File Excel d·ªØ li·ªáu (.xlsx)</label>
        <input type="file" id="data" accept=".xlsx">
    </div>

    <div class="input-group">
        <label>3. Ch·ªçn t·∫•t c·∫£ ·∫£nh kh·∫£o s√°t</label>
        <input type="file" id="imgs" multiple accept="image/*">
    </div>

    <button class="btn" id="mainBtn" disabled onclick="generate()">ƒêANG KH·ªûI ƒê·ªòNG TH∆Ø VI·ªÜN...</button>
    <div id="status"></div>
</div>

<script>
    let photoLibrary = {};
    const btn = document.getElementById('mainBtn');
    const status = document.getElementById('status');

    // Ki·ªÉm tra th∆∞ vi·ªán "s·ªëng" ch∆∞a m·ªõi cho l√†m vi·ªác
    const checkTimer = setInterval(() => {
        // Ki·ªÉm tra xem c√°c ƒë·ªëi t∆∞·ª£ng th∆∞ vi·ªán ƒë√£ n·∫±m trong c·ª≠a s·ªï tr√¨nh duy·ªát ch∆∞a
        const libs = {
            "PizZip": !!window.PizZip,
            "Docxtemplater": !!window.docxtemplater,
            "ExcelJS": !!window.XLSX,
            "ImageModule": !!window.DocxtemplaterImageModuleV2
        };

        const missing = Object.keys(libs).filter(k => !libs[k]);

        if (missing.length === 0) {
            clearInterval(checkTimer);
            btn.disabled = false;
            btn.style.background = "var(--p)"; // Hi·ªán m√†u xanh khi s·∫µn s√†ng
            btn.innerText = "üöÄ T·∫†O FILE WORD T·ªîNG H·ª¢P";
            status.style.display = "none";
        } else {
            // Hi·ªÉn th·ªã cho b·ªì bi·∫øt ch√≠nh x√°c th∆∞ vi·ªán n√†o ƒëang b·ªã k·∫πt
            btn.innerText = `‚è≥ ƒêang ƒë·ª£i: ${missing.join(', ')}...`;
            status.innerHTML = `‚ö†Ô∏è ƒêang t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß: <b>${missing[0]}</b>...`;
            status.className = "loading";
            status.style.display = "block";
        }
    }, 500);

    // X·ª≠ l√Ω ƒë·ªçc ·∫£nh m∆∞·ª£t m√†
    document.getElementById('imgs').onchange = function(e) {
        photoLibrary = {}; 
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => { photoLibrary[file.name] = ev.target.result; };
            reader.readAsArrayBuffer(file);
        });
    };

    async function generate() {
        const tplFile = document.getElementById('tpl').files[0];
        const dataFile = document.getElementById('data').files[0];

        if(!tplFile || !dataFile) {
            showStatus("B·ªì qu√™n ch·ªçn file r·ªìi k√¨a!", "error");
            return;
        }

        showStatus("‚è≥ ƒêang x·ª≠ l√Ω d·ªØ li·ªáu, b·ªì ch·ªù t√≠...", "loading");

        try {
            // 1. ƒê·ªçc d·ªØ li·ªáu Excel
            const exBuf = await dataFile.arrayBuffer();
            const wb = XLSX.read(exBuf);
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

            // 2. C·∫•u h√¨nh Image Module an to√†n
            const imageOptions = {
                getImage: (tagValue) => {
                    if (!photoLibrary[tagValue]) {
                        console.warn("Kh√¥ng t√¨m th·∫•y ·∫£nh: " + tagValue);
                        return null;
                    }
                    return photoLibrary[tagValue];
                },
                getSize: () => [450, 300] // K√≠ch th∆∞·ªõc ·∫£nh t·ª± ƒë·ªông c√¢n ch·ªânh
            };
            
            // Fix l·ªói "is not a constructor" b·∫±ng c√°ch g·ªçi ƒë√∫ng ƒë∆∞·ªùng d·∫´n bundle
            const imgMod = new window.DocxtemplaterImageModuleV2(imageOptions);

            // 3. X·ª≠ l√Ω Word
            const zip = new PizZip(await tplFile.arrayBuffer());
            const doc = new window.docxtemplater(zip, { 
                modules: [imgMod], 
                paragraphLoop: true, 
                linebreaks: true 
            });

            doc.render({ rows: rows });

            // 4. Xu·∫•t file
            const out = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            });
            
            saveAs(out, "Bao_Cao_Tong_Hop_Hoan_Thien.docx");
            showStatus("‚úÖ Xu·∫•t b√°o c√°o th√†nh c√¥ng r·ª±c r·ª°!", "success");

        } catch (e) {
            showStatus("‚ùå L·ªói: " + e.message, "error");
            console.error(e);
        }
    }

    function showStatus(txt, type) {
        status.innerText = txt;
        status.className = type;
    }
</script>
</body>
</html>
