<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B·∫£n Fix Tr·∫Øng File - Ch·ªØ Ph·∫£i L√™n</title>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.21.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f8fafc; text-align: center; }
        .box { background: white; padding: 25px; border-radius: 12px; display: inline-block; text-align: left; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 420px; }
        input { width: 100%; margin: 10px 0 20px; }
        button { width: 100%; padding: 12px; background: #1d4ed8; color: white; border: none; cursor: pointer; border-radius: 6px; font-weight: bold; }
        #status { margin-top: 15px; font-weight: bold; color: #334155; }
    </style>
</head>
<body>

<div class="box">
    <h3>üìÇ B√°o C√°o Kh√¥ng Tr·∫Øng File</h3>
    <label>1. Word m·∫´u:</label> <input type="file" id="w">
    <label>2. Excel d·ªØ li·ªáu:</label> <input type="file" id="x">
    <label>3. Ch·ªçn ·∫£nh kh·∫£o s√°t:</label> <input type="file" id="i" multiple>
    <button onclick="handle()">üöÄ XU·∫§T FILE</button>
    <div id="status">Ch∆∞a ch·∫°y</div>
</div>

<script>
    let photoVault = {};
    document.getElementById('i').onchange = (e) => {
        Array.from(e.target.files).forEach(f => {
            const r = new FileReader();
            r.onload = (ev) => { photoVault[f.name] = ev.target.result; };
            r.readAsArrayBuffer(f);
        });
    };

    async function handle() {
        const st = document.getElementById('status');
        try {
            const fW = document.getElementById('w').files[0];
            const fX = document.getElementById('x').files[0];
            if(!fW || !fX) return alert("Thi·∫øu file k√¨a b·ªì!");

            st.innerText = "‚è≥ ƒêang n·∫°p d·ªØ li·ªáu...";
            const xBuf = await fX.arrayBuffer();
            const data = XLSX.utils.sheet_to_json(XLSX.read(xBuf).Sheets[XLSX.read(xBuf).SheetNames[0]]);

            // L√†m s·∫°ch d·ªØ li·ªáu ƒë·ªÉ tr√°nh l·ªói XML
            const rows = JSON.parse(JSON.stringify(data));

            const zip = new window.PizZip(await fW.arrayBuffer());
            const doc = new window.docxtemplater();
            doc.loadZip(zip);

            // C·∫•u h√¨nh ·∫£nh: Tr·∫£ v·ªÅ ·∫£nh tr·ªëng n·∫øu l·ªói ƒë·ªÉ kh√¥ng l√†m tr·∫Øng file
            const imgMod = new window.ImageModule({
                getImage: function(name) {
                    if (!photoVault[name]) return null;
                    return photoVault[name];
                },
                getSize: function() { return [400, 300]; }
            });
            doc.attachModule(imgMod);

            // ƒê·∫∑t d·ªØ li·ªáu
            doc.setData({ rows: rows });

            st.innerText = "‚è≥ ƒêang t·∫°o file Word...";
            // KH√îNG d√πng render tr·ª±c ti·∫øp ƒë·ªÉ tr√°nh crash tr·∫Øng trang
            try {
                doc.render();
            } catch (err) {
                st.innerText = "‚ùå L·ªói Render: " + err.message;
                throw err;
            }

            const out = doc.getZip().generate({type: "blob"});
            saveAs(out, "Bao_Cao_Chot_Ha.docx");
            st.innerText = "‚úÖ ƒê√É XU·∫§T FILE!";

        } catch (e) {
            console.error(e);
            alert("L·ªói h·ªá th·ªëng: " + e.message);
        }
    }
</script>
</body>
</html>
