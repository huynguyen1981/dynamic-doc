<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,">
    <title>Excel to Word - B·∫£n Ch·ªët H√¨nh ·∫¢nh</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.21.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { width: 100%; max-width: 500px; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        label { display: block; font-size: 0.8rem; font-weight: 700; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        input[type="file"] { width: 100%; margin-bottom: 20px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { width: 100%; padding: 15px; background: #94a3b8; color: white; border: none; border-radius: 10px; font-weight: 700; cursor: not-allowed; transition: 0.3s; }
        #status { margin-top: 20px; text-align: center; font-size: 0.85rem; font-weight: 600; padding: 10px; border-radius: 8px; }
        .loading { background: #fff7ed; color: #c2410c; }
        .ready { background: #f0fdf4; color: #15803d; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align: center; color: #1e293b;">üìä Excel To Word (Fixed)</h2>
    
    <label>1. File Word m·∫´u ({%HINH_ANH})</label>
    <input type="file" id="wordFile" accept=".docx">

    <label>2. File Excel (C·ªôt HINH_ANH kh√¥ng c√≥ %)</label>
    <input type="file" id="xlsxFile" accept=".xlsx">

    <label>3. Ch·ªçn t·∫•t c·∫£ ·∫£nh kh·∫£o s√°t</label>
    <input type="file" id="imgFiles" multiple accept="image/*">

    <button class="btn" id="mainBtn" disabled onclick="process()">ƒêANG KI·ªÇM TRA TH∆Ø VI·ªÜN...</button>
    <div id="status" class="loading">‚è≥ Ch·ªù k·∫øt n·ªëi...</div>
</div>

<script>
    let photoLib = {};
    const btn = document.getElementById('mainBtn');
    const status = document.getElementById('status');

    // Ch·ªù th∆∞ vi·ªán n·∫°p xong
    const checkTimer = setInterval(() => {
        const isDocxReady = window.docxtemplater || window.Docxtemplater;
        const isImgReady = window.ImageModule || window.DocxtemplaterImageModuleV2;
        if (window.PizZip && isDocxReady && window.XLSX && isImgReady) {
            clearInterval(checkTimer);
            btn.disabled = false;
            btn.style.background = "var(--p)";
            btn.style.cursor = "pointer";
            btn.innerText = "üöÄ XU·∫§T FILE NGAY";
            status.innerText = "‚úÖ ƒê√£ s·∫µn s√†ng n·∫°p d·ªØ li·ªáu!";
            status.className = "ready";
        }
    }, 500);

    // ƒê·ªçc ·∫£nh v√†o b·ªô nh·ªõ
    document.getElementById('imgFiles').onchange = (e) => {
        photoLib = {};
        Array.from(e.target.files).forEach(file => {
            const r = new FileReader();
            r.onload = (ev) => { photoLib[file.name] = ev.target.result; };
            r.readAsArrayBuffer(file);
        });
    };

    async function process() {
        const wInput = document.getElementById('wordFile').files[0];
        const xInput = document.getElementById('xlsxFile').files[0];
        if(!wInput || !xInput) return alert("B·ªì ∆°i, ch·ªçn ƒë·ªß Word v√† Excel ƒë√£!");

        try {
            status.innerText = "‚è≥ ƒêang x·ª≠ l√Ω (N√© l·ªói Namespace)...";
            const wordBuf = await wInput.arrayBuffer();
            const xlsxBuf = await xInput.arrayBuffer();
            
            // ƒê·ªçc Excel v√† l√†m s·∫°ch d·ªØ li·ªáu
            const wb = XLSX.read(xlsxBuf, {type: 'array'});
            const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const rows = JSON.parse(JSON.stringify(rawData)); // B∆∞·ªõc "r·ª≠a" d·ªØ li·ªáu quan tr·ªçng

            // C·∫•u h√¨nh Image Module
            const imgOptions = {
                getImage: (tagValue) => {
                    if (!photoLib[tagValue]) {
                        console.warn("Kh√¥ng t√¨m th·∫•y file ·∫£nh: ", tagValue);
                        return null;
                    }
                    return photoLib[tagValue];
                },
                getSize: () => [450, 300] // ƒê·ªô r·ªông 450px, cao 300px trong Word
            };

            const ImgModuleCtor = window.ImageModule || window.DocxtemplaterImageModuleV2;
            const zip = new PizZip(wordBuf);
            const DocxTemplate = window.docxtemplater || window.Docxtemplater;
            
            // Kh·ªüi t·∫°o
            const doc = new DocxTemplate(zip, {
                modules: [new ImgModuleCtor(imgOptions)],
                paragraphLoop: true,
                linebreaks: true
            });

            // RENDER - D·ªØ li·ªáu rows c√≥ key "HINH_ANH" s·∫Ω kh·ªõp v·ªõi th·∫ª "{%HINH_ANH}"
            doc.render({ rows: rows });

            const out = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            });
            
            saveAs(out, "Bao_Cao_Hoan_Thien.docx");
            status.innerText = "‚úÖ Xong r·ªìi! H√¨nh ·∫£nh ƒë√£ ch√®n m∆∞·ª£t m√†.";
            status.className = "ready";
        } catch (err) {
            console.error(err);
            alert("L·ªói: " + err.message);
            status.innerText = "‚ùå L·ªói khi render.";
        }
    }
</script>
</body>
</html>
