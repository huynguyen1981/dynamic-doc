<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,">
    <title>B√°o C√°o Kh·∫£o S√°t - B·∫£n Fix Link Chu·∫©n</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { width: 100%; max-width: 550px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .btn { width: 100%; padding: 16px; background: #94a3b8; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: not-allowed; transition: 0.3s; margin-top: 10px; }
        #status { margin-top: 20px; text-align: center; font-size: 0.85rem; font-weight: 600; padding: 12px; border-radius: 8px; border: 1px solid transparent; }
        .loading { background: #fff7ed; color: #c2410c; border-color: #ffedd5; }
        .ready { background: #f0fdf4; color: #15803d; border-color: #dcfce7; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align: center; color: #1e293b; margin-top: 0;">üìä Excel To Word Report</h2>
    
    <div style="margin-bottom:15px">
        <label>1. M·∫´u Word ({#rows}...{%ANH}...{/rows})</label>
        <input type="file" id="wordTpl" accept=".docx" style="width:100%">
    </div>
    
    <div style="margin-bottom:15px">
        <label>2. D·ªØ li·ªáu Excel (.xlsx)</label>
        <input type="file" id="excelData" accept=".xlsx" style="width:100%">
    </div>
    
    <div style="margin-bottom:15px">
        <label>3. Ch·ªçn t·∫•t c·∫£ ·∫£nh kh·∫£o s√°t</label>
        <input type="file" id="imgFiles" multiple accept="image/*" style="width:100%">
    </div>

    <button class="btn" id="mainBtn" disabled onclick="handleExport()">ƒêANG ƒê·ª¢I TH∆Ø VI·ªÜN...</button>
    <div id="status" class="loading">‚è≥ ƒêang n·∫°p t√†i nguy√™n...</div>
</div>

<script>
    let photoData = {};
    const btn = document.getElementById('mainBtn');
    const status = document.getElementById('status');

    // Ki·ªÉm tra th∆∞ vi·ªán n·∫°p xong ch∆∞a
    const checkTimer = setInterval(() => {
        // L∆∞u √Ω: Link imagemodule.min.js th∆∞·ªùng n·∫°p v√†o bi·∫øn ImageModule
        const imgModReady = !!window.ImageModule || !!window.DocxtemplaterImageModuleV2;

        if (window.PizZip && (window.docxtemplater || window.Docxtemplater) && window.XLSX && imgModReady) {
            clearInterval(checkTimer);
            btn.disabled = false;
            btn.style.background = "var(--p)";
            btn.style.cursor = "pointer";
            btn.innerText = "üöÄ T·∫†O B√ÅO C√ÅO NGAY";
            status.innerText = "‚úÖ Link chu·∫©n ƒë√£ n·∫°p th√†nh c√¥ng!";
            status.className = "ready";
        }
    }, 300);

    document.getElementById('imgFiles').onchange = (e) => {
        photoData = {};
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => { photoData[file.name] = ev.target.result; };
            reader.readAsArrayBuffer(file);
        });
    };

    async function handleExport() {
        try {
            status.innerText = "‚è≥ ƒêang t·∫°o file b√°o c√°o...";
            const wordBuf = await document.getElementById('wordTpl').files[0].arrayBuffer();
            const exBuf = await document.getElementById('excelData').files[0].arrayBuffer();
            
            const rows = XLSX.utils.sheet_to_json(XLSX.read(exBuf).Sheets[XLSX.read(exBuf).SheetNames[0]]);
            
            const ImgModule = window.ImageModule || window.DocxtemplaterImageModuleV2;
            const imgInstance = new ImgModule({
                getImage: (name) => photoData[name],
                getSize: () => [500, 350]
            });

            const zip = new PizZip(wordBuf);
            const Docx = window.docxtemplater || window.Docxtemplater;
            const doc = new Docx(zip, { modules: [imgInstance], paragraphLoop: true, linebreaks: true });

            doc.render({ rows: rows });
            saveAs(doc.getZip().generate({ type: "blob" }), "Bao_Cao_Tong_Hop.docx");
            status.innerText = "‚úÖ Xu·∫•t file th√†nh c√¥ng!";
        } catch (e) {
            alert("L·ªói: " + e.message);
            status.innerText = "‚ùå L·ªói khi x·ª≠ l√Ω.";
        }
    }
</script>
</body>
</html>
