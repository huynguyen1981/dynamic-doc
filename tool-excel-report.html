<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Excel to Word - Version 3.24.0</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.24.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; display: flex; justify-content: center; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 450px; }
        h3 { color: #1e293b; text-align: center; margin-bottom: 20px; }
        label { display: block; font-size: 13px; font-weight: 600; color: #64748b; margin-top: 15px; }
        input { width: 100%; margin: 8px 0 15px; border: 1px solid #cbd5e1; padding: 8px; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #status { margin-top: 15px; text-align: center; font-size: 14px; font-weight: 600; color: #334155; }
    </style>
</head>
<body>

<div class="card">
    <h3>üìä B√°o C√°o T·ª± ƒê·ªông (v3.24.0)</h3>
    
    <label>1. File Word ({#rows} ... {/rows})</label>
    <input type="file" id="wordFile">

    <label>2. File Excel (C·ªôt HINH_ANH)</label>
    <input type="file" id="excelFile">

    <label>3. Ch·ªçn t·∫•t c·∫£ ·∫£nh</label>
    <input type="file" id="imgFiles" multiple>

    <button onclick="execute()">üöÄ XU·∫§T FILE NGAY</button>
    <div id="status">S·∫µn s√†ng!</div>
</div>

<script>
    let photoLib = {};
    document.getElementById('imgFiles').onchange = (e) => {
        Array.from(e.target.files).forEach(f => {
            const r = new FileReader();
            r.onload = (ev) => { photoLib[f.name] = ev.target.result; };
            r.readAsArrayBuffer(f);
        });
    };

    async function execute() {
        const st = document.getElementById('status');
        try {
            const fW = document.getElementById('wordFile').files[0];
            const fX = document.getElementById('excelFile').files[0];
            if(!fW || !fX) return alert("B·ªì ∆°i, thi·∫øu file r·ªìi!");

            st.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";

            // 1. ƒê·ªçc Excel v√† l√†m s·∫°ch d·ªØ li·ªáu
            const xBuf = await fX.arrayBuffer();
            const rawData = XLSX.utils.sheet_to_json(XLSX.read(xBuf).Sheets[XLSX.read(xBuf).SheetNames[0]]);
            const cleanRows = JSON.parse(JSON.stringify(rawData)); // R·ª≠a d·ªØ li·ªáu ƒë·ªÉ n√© l·ªói Namespace

            // 2. C·∫•u h√¨nh Image Module cho 3.24.0
            const imgOptions = {
                getImage: (name) => photoLib[name] || null,
                getSize: () => [450, 300]
            };
            const ImgModule = window.ImageModule || window.DocxtemplaterImageModuleV2;

            // 3. Kh·ªüi t·∫°o Word
            const zip = new window.PizZip(await fW.arrayBuffer());
            const doc = new window.docxtemplater(zip, {
                modules: [new ImgModule(imgOptions)],
                paragraphLoop: true,
                linebreaks: true
            });

            // 4. Render v·ªõi d·ªØ li·ªáu
            doc.render({ rows: cleanRows });

            const out = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            });
            
            saveAs(out, "Bao_Cao_v324.docx");
            st.innerText = "‚úÖ Th√†nh c√¥ng r·ªìi b·ªì!";

        } catch (e) {
            console.error(e);
            // Hi·ªÉn th·ªã l·ªói chi ti·∫øt ƒë·ªÉ b·ªì d·ªÖ s·ª≠a
            let errMsg = e.message;
            if (e.properties && e.properties.errors) {
                errMsg = e.properties.errors.map(err => err.properties.explanation).join("\n");
            }
            alert("L·ªói: " + errMsg);
            st.innerText = "‚ùå Th·∫•t b·∫°i.";
        }
    }
</script>
</body>
</html>
