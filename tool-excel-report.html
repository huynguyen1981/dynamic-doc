<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,">
    <title>Excel to Word - Final Stable</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { width: 100%; max-width: 500px; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .btn { width: 100%; padding: 15px; background: #94a3b8; color: white; border: none; border-radius: 10px; font-weight: 700; cursor: not-allowed; transition: 0.3s; margin-top: 15px; }
        #status { margin-top: 20px; text-align: center; font-size: 0.85rem; font-weight: 600; padding: 10px; border-radius: 8px; }
        .loading { background: #fff7ed; color: #c2410c; }
        .ready { background: #f0fdf4; color: #15803d; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align: center; margin-bottom: 25px;">üìä Xu·∫•t B√°o C√°o S·∫°ch</h2>
    
    <div style="margin-bottom:15px">
        <label style="display:block; font-size:0.8rem; font-weight:700; color:#64748b; margin-bottom:5px">1. FILE WORD M·∫™U</label>
        <input type="file" id="wordFile" accept=".docx" style="width:100%">
    </div>

    <div style="margin-bottom:15px">
        <label style="display:block; font-size:0.8rem; font-weight:700; color:#64748b; margin-bottom:5px">2. FILE EXCEL D·ªÆ LI·ªÜU</label>
        <input type="file" id="xlsxFile" accept=".xlsx" style="width:100%">
    </div>

    <div style="margin-bottom:15px">
        <label style="display:block; font-size:0.8rem; font-weight:700; color:#64748b; margin-bottom:5px">3. CH·ªåN ·∫¢NH</label>
        <input type="file" id="imgFiles" multiple accept="image/*" style="width:100%">
    </div>

    <button class="btn" id="mainBtn" disabled onclick="process()">ƒêANG KI·ªÇM TRA...</button>
    <div id="status" class="loading">‚è≥ ƒêang n·∫°p th∆∞ vi·ªán...</div>
</div>

<script>
    let photoLib = {};
    const btn = document.getElementById('mainBtn');
    const status = document.getElementById('status');

    // Ch·ªù th∆∞ vi·ªán n·∫°p xong
    const checkTimer = setInterval(() => {
        const docx = window.docxtemplater || window.Docxtemplater;
        const imgMod = window.ImageModule || window.DocxtemplaterImageModuleV2;
        if (window.PizZip && docx && window.XLSX && imgMod) {
            clearInterval(checkTimer);
            btn.disabled = false;
            btn.style.background = "var(--p)";
            btn.style.cursor = "pointer";
            btn.innerText = "üöÄ XU·∫§T FILE T·ªîNG H·ª¢P";
            status.innerText = "‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!";
            status.className = "ready";
        }
    }, 500);

    document.getElementById('imgFiles').onchange = (e) => {
        photoLib = {};
        Array.from(e.target.files).forEach(file => {
            const r = new FileReader();
            r.onload = (ev) => { photoLib[file.name] = ev.target.result; };
            r.readAsArrayBuffer(file);
        });
    };

    async function process() {
        try {
            status.innerText = "‚è≥ ƒêang x·ª≠ l√Ω d·ªØ li·ªáu s·∫°ch...";
            const wordBuf = await document.getElementById('wordFile').files[0].arrayBuffer();
            const xlsxBuf = await document.getElementById('xlsxFile').files[0].arrayBuffer();
            
            // ƒê·ªçc Excel v√† chuy·ªÉn v·ªÅ JSON nguy√™n b·∫£n (tr√°nh l·ªói object ph·ª©c t·∫°p)
            const wb = XLSX.read(xlsxBuf, {type: 'array'});
            const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            const rows = JSON.parse(JSON.stringify(rawData)); // L·ªçc s·∫°ch thu·ªôc t√≠nh l·∫°

            const ImgModuleCtor = window.ImageModule || window.DocxtemplaterImageModuleV2;
            const imgOpts = {
                centered: false,
                getImage: (tagValue) => photoLib[tagValue],
                getSize: () => [450, 300]
            };

            const zip = new PizZip(wordBuf);
            const DocxTemplate = window.docxtemplater || window.Docxtemplater;
            
            // Kh·ªüi t·∫°o v√† render theo c√°ch "an to√†n" nh·∫•t
            const doc = new DocxTemplate(zip, {
                modules: [new ImgModuleCtor(imgOpts)],
                paragraphLoop: true,
                linebreaks: true
            });

            // Ch·∫°y Render v·ªõi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l·ªçc s·∫°ch
            doc.render({ rows: rows });

            const out = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            });
            
            saveAs(out, "Ket_Qua_Final.docx");
            status.innerText = "‚úÖ Ho√†n th√†nh r·ª±c r·ª°!";
            status.className = "ready";
        } catch (err) {
            console.error("L·ªói chi ti·∫øt:", err);
            alert("L·ªói: " + err.message);
            status.innerText = "‚ùå L·ªói h·ªá th·ªëng.";
        }
    }
</script>
</body>
</html>
