<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,"> 
    <title>Excel to Word - Fast Load</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docxtemplater-image-module-free@1.1.1/build/bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { width: 100%; max-width: 500px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        h2 { text-align: center; color: #1e293b; margin-top: 0; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #64748b; }
        input[type="file"] { width: 100%; padding: 10px; border: 2px dashed #cbd5e1; border-radius: 12px; box-sizing: border-box; }
        .btn { width: 100%; padding: 16px; background: #94a3b8; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: not-allowed; transition: 0.3s; margin-top: 10px; }
        #status { margin-top: 20px; text-align: center; font-size: 0.85rem; font-weight: 600; padding: 10px; border-radius: 8px; }
        .loading { background: #fff7ed; color: #c2410c; }
        .ready { background: #f0fdf4; color: #15803d; }
    </style>
</head>
<body>

<div class="box">
    <h2>üìä Excel to Word</h2>
    
    <div class="input-group">
        <label>1. File Word m·∫´u (.docx)</label>
        <input type="file" id="tpl" accept=".docx">
    </div>

    <div class="input-group">
        <label>2. File Excel d·ªØ li·ªáu (.xlsx)</label>
        <input type="file" id="data" accept=".xlsx">
    </div>

    <div class="input-group">
        <label>3. Ch·ªçn t·∫•t c·∫£ ·∫£nh kh·∫£o s√°t</label>
        <input type="file" id="imgs" multiple accept="image/*">
    </div>

    <button class="btn" id="mainBtn" onclick="generate()" disabled>ƒêANG T·∫¢I TH∆Ø VI·ªÜN...</button>
    <div id="status" class="loading">‚è≥ ƒêang n·∫°p th∆∞ vi·ªán h·ªá th·ªëng...</div>
</div>

<script>
    let photoLibrary = {};
    const btn = document.getElementById('mainBtn');
    const status = document.getElementById('status');

    // Ki·ªÉm tra xem ImageModule c√≥ ƒë∆∞·ª£c n·∫°p d∆∞·ªõi t√™n kh√°c kh√¥ng (ph√≤ng h·ªù l·ªói constructor)
    function getImageModule() {
        return window.DocxtemplaterImageModuleV2 || window.ImageModule;
    }

    const checkTimer = setInterval(() => {
        const libs = {
            "PizZip": !!window.PizZip,
            "Docxtemplater": !!window.docxtemplater,
            "XLSX": !!window.XLSX,
            "ImageModule": !!getImageModule()
        };

        const missing = Object.keys(libs).filter(k => !libs[k]);

        if (missing.length === 0) {
            clearInterval(checkTimer);
            btn.disabled = false;
            btn.style.background = "var(--p)";
            btn.style.cursor = "pointer";
            btn.innerText = "üöÄ T·∫†O B√ÅO C√ÅO NGAY";
            status.innerText = "‚úÖ H·ªá th·ªëng s·∫µn s√†ng!";
            status.className = "ready";
        } else {
            status.innerText = `‚è≥ ƒêang ƒë·ª£i n·∫°p: ${missing.join(', ')}...`;
        }
    }, 500);

    document.getElementById('imgs').onchange = function(e) {
        photoLibrary = {};
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => { photoLibrary[file.name] = ev.target.result; };
            reader.readAsArrayBuffer(file);
        });
    };

    async function generate() {
        const tplFile = document.getElementById('tpl').files[0];
        const dataFile = document.getElementById('data').files[0];
        const ImageModuleClass = getImageModule();

        if(!tplFile || !dataFile) return alert("B·ªì ch·ªçn ƒë·ªß file Word v√† Excel ƒë√£ nh√©!");

        try {
            status.innerText = "‚è≥ ƒêang t·∫°o file Word, b·ªì ƒë·ª´ng ƒë√≥ng trang nh√©...";
            
            const exBuf = await dataFile.arrayBuffer();
            const workbook = XLSX.read(exBuf);
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

            const imgOptions = {
                getImage: (name) => photoLibrary[name],
                getSize: (img, tagValue, tagName) => [500, 350] // K√≠ch th∆∞·ªõc ·∫£nh trong Word
            };
            
            const imgMod = new ImageModuleClass(imgOptions);
            const zip = new PizZip(await tplFile.arrayBuffer());
            const doc = new window.docxtemplater(zip, { 
                modules: [imgMod], 
                paragraphLoop: true, 
                linebreaks: true 
            });

            doc.render({ rows: rows });
            const out = doc.getZip().generate({ type: "blob" });
            saveAs(out, "Bao_Cao_Tong_Hop.docx");
            
            status.innerText = "‚úÖ Ho√†n th√†nh! File ƒë√£ t·∫£i xu·ªëng.";
        } catch (e) {
            console.error(e);
            alert("L·ªói: " + e.message);
            status.innerText = "‚ùå L·ªói x·ª≠ l√Ω d·ªØ li·ªáu.";
        }
    }
</script>
</body>
</html>
