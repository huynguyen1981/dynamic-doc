<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B·∫£n Fix Multi-Error Cu·ªëi C√πng</title>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.21.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 30px; line-height: 1.6; background: #f0f2f5; }
        .card { background: white; padding: 25px; border-radius: 12px; max-width: 500px; margin: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input { display: block; width: 100%; margin: 10px 0 20px; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 5px; }
        #log { margin-top: 20px; font-size: 12px; color: red; white-space: pre-wrap; background: #fff1f0; padding: 10px; display: none; border-radius: 5px; }
    </style>
</head>
<body>
<div class="card">
    <h3>üõ† Fix Tri·ªát ƒê·ªÉ Multi-Error</h3>
    <label>1. Word m·∫´u ({%HINH_ANH})</label>
    <input type="file" id="wFile">
    <label>2. Excel (C·ªôt HINH_ANH)</label>
    <input type="file" id="xFile">
    <label>3. Ch·ªçn ·∫£nh (Ph·∫£i tr√πng t√™n trong Excel)</label>
    <input type="file" id="iFiles" multiple>
    <button onclick="doExport()">üöÄ XU·∫§T FILE</button>
    <div id="status" style="text-align:center; margin-top:10px;">Ch·ªù l·ªánh...</div>
    <div id="log"></div>
</div>

<script>
    let photoVault = {};
    document.getElementById('iFiles').onchange = (e) => {
        Array.from(e.target.files).forEach(f => {
            const r = new FileReader();
            r.onload = (ev) => { photoVault[f.name] = ev.target.result; };
            r.readAsArrayBuffer(f);
        });
    };

    async function doExport() {
        const log = document.getElementById('log');
        const st = document.getElementById('status');
        log.style.display = "none";
        try {
            const fW = document.getElementById('wFile').files[0];
            const fX = document.getElementById('xFile').files[0];
            if(!fW || !fX) return alert("Thi·∫øu file b·ªì ∆°i!");

            st.innerText = "‚è≥ ƒêang ch·∫°y...";
            const xBuf = await fX.arrayBuffer();
            const data = XLSX.utils.sheet_to_json(XLSX.read(xBuf).Sheets[XLSX.read(xBuf).SheetNames[0]]);
            const cleanRows = JSON.parse(JSON.stringify(data));

            const imgOpts = {
                getImage: (tagV) => {
                    if (!photoVault[tagV]) {
                        console.warn("M·∫•t ·∫£nh:", tagV);
                        return null; // Tr·∫£ v·ªÅ null ƒë·ªÉ tr√°nh Multi-error
                    }
                    return photoVault[tagV];
                },
                getSize: () => [400, 300],
                // Quan tr·ªçng: H√†m n√†y gi√∫p b·ªè qua l·ªói n·∫øu kh√¥ng c√≥ ·∫£nh
                errorHandler: (err, tagName, tagValue) => {
                    console.log("L·ªói t·∫°i th·∫ª:", tagName);
                    return ""; 
                }
            };

            const zip = new window.PizZip(await fW.arrayBuffer());
            const doc = new window.docxtemplater();
            doc.loadZip(zip);
            
            const ImgMod = window.ImageModule || window.DocxtemplaterImageModuleV2;
            doc.attachModule(new ImgMod(imgOpts));

            doc.setData({ rows: cleanRows });
            
            try {
                doc.render();
            } catch (e) {
                // N·∫øu v·∫´n Multi-error, m·ªï x·∫ª t·∫≠n g·ªëc ·ªü ƒë√¢y
                if (e.properties && e.properties.errors) {
                    const msg = e.properties.errors.map(err => err.properties.explanation).join("\n");
                    log.innerText = "L·ªói chi ti·∫øt:\n" + msg;
                    log.style.display = "block";
                }
                throw e;
            }

            const out = doc.getZip().generate({type: "blob"});
            saveAs(out, "Bao_Cao_Dut_Diem.docx");
            st.innerText = "‚úÖ XONG R·ªíI B·ªí ∆†I!";
        } catch (err) {
            st.innerText = "‚ùå Th·∫•t b·∫°i.";
            console.error(err);
        }
    }
</script>
</body>
</html>
