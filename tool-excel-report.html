<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,">
    <title>Excel to Word - No More Errors</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { width: 100%; max-width: 500px; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .btn { width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
        #status { margin-top: 20px; text-align: center; font-size: 0.85rem; font-weight: 600; padding: 10px; border-radius: 8px; background: #f1f5f9; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align: center;">üìä B√°o C√°o Si√™u T·ªëc</h2>
    <p style="font-size: 0.8rem; color: #666; text-align: center;">(B·∫£n v√° l·ªói NamespaceURI)</p>
    
    <div style="margin-top:20px">
        <label>1. M·∫´u Word (.docx)</label>
        <input type="file" id="wordFile" accept=".docx" style="width:100%; margin-bottom:15px">
        
        <label>2. D·ªØ li·ªáu Excel (.xlsx)</label>
        <input type="file" id="xlsxFile" accept=".xlsx" style="width:100%; margin-bottom:15px">
        
        <label>3. ·∫¢nh kh·∫£o s√°t</label>
        <input type="file" id="imgFiles" multiple accept="image/*" style="width:100%; margin-bottom:20px">
    </div>

    <button class="btn" onclick="generateReport()">üöÄ T·∫†O B√ÅO C√ÅO NGAY</button>
    <div id="status">S·∫µn s√†ng!</div>
</div>

<script>
    let photoVault = {};

    document.getElementById('imgFiles').onchange = (e) => {
        Array.from(e.target.files).forEach(f => {
            const r = new FileReader();
            r.onload = (ev) => { photoVault[f.name] = ev.target.result; };
            r.readAsArrayBuffer(f);
        });
    };

    async function generateReport() {
        const st = document.getElementById('status');
        try {
            st.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
            const wFile = document.getElementById('wordFile').files[0];
            const xFile = document.getElementById('xlsxFile').files[0];
            if(!wFile || !xFile) return alert("Ch·ªçn ƒë·ªß file b·ªì ∆°i!");

            // 1. ƒê·ªçc Excel
            const xBuf = await xFile.arrayBuffer();
            const rows = XLSX.utils.sheet_to_json(XLSX.read(xBuf).Sheets[XLSX.read(xBuf).SheetNames[0]]);

            // 2. ƒê·ªçc Word & X·ª≠ l√Ω l·ªói XML (NamespaceURI fix)
            const wBuf = await wFile.arrayBuffer();
            const zip = new PizZip(wBuf);
            
            // 3. C·∫•u h√¨nh Image Module
            const ImgModule = window.ImageModule || window.DocxtemplaterImageModuleV2;
            const imgOptions = {
                getImage: (name) => photoVault[name],
                getSize: () => [500, 350]
            };

            // 4. Kh·ªüi t·∫°o Docxtemplater v·ªõi c·∫•u h√¨nh TR√ÅNH L·ªñI PHI√äN B·∫¢N
            const doc = new window.docxtemplater(zip, {
                modules: [new ImgModule(imgOptions)],
                paragraphLoop: true,
                linebreaks: true,
                // √âp th∆∞ vi·ªán d√πng c∆° ch·∫ø c≈© ƒë·ªÉ n√© namespaceURI l·ªói
                parser: function(tag) {
                    return {
                        get: function(scope) {
                            return scope[tag];
                        }
                    };
                }
            });

            // 5. Render v√† Xu·∫•t file
            doc.render({ rows: rows });
            const out = doc.getZip().generate({type: "blob"});
            saveAs(out, "Bao_Cao_Dut_Diem_Loi.docx");
            st.innerText = "‚úÖ Th√†nh c√¥ng r√πi b·ªì!";
        } catch (e) {
            console.error(e);
            st.innerText = "‚ùå L·ªói: " + e.message;
            alert("V·∫´n l·ªói b·ªì ∆°i! H√£y th·ª≠ d√πng 1 file Word tr·∫Øng ho√†n to√†n xem sao.");
        }
    }
</script>
</body>
</html>
