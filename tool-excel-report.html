<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o C√°o Ho√†n H·∫£o - Fix Namespace Error</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.21.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; justify-content: center; padding-top: 50px; }
        .box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 480px; }
        h2 { text-align: center; color: #333; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; font-size: 0.9rem; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #status { margin-top: 20px; text-align: center; font-weight: 600; color: #666; }
    </style>
</head>
<body>

<div class="box">
    <h2>üìä Xu·∫•t B√°o C√°o S·∫°ch</h2>
    
    <label>1. M·∫´u Word ({%HINH_ANH})</label>
    <input type="file" id="wordInp" accept=".docx">

    <label>2. D·ªØ li·ªáu Excel (C·ªôt HINH_ANH)</label>
    <input type="file" id="excelInp" accept=".xlsx">

    <label>3. ·∫¢nh kh·∫£o s√°t</label>
    <input type="file" id="imgInp" multiple accept="image/*">

    <button class="btn" onclick="processReport()">üöÄ T·∫†O B√ÅO C√ÅO NGAY</button>
    <div id="status">S·∫µn s√†ng!</div>
</div>

<script>
    let photoVault = {};

    // N·∫°p ·∫£nh v√†o b·ªô nh·ªõ ngay khi ch·ªçn
    document.getElementById('imgInp').onchange = (e) => {
        photoVault = {};
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => { photoVault[file.name] = ev.target.result; };
            reader.readAsArrayBuffer(file);
        });
    };

    async function processReport() {
        const st = document.getElementById('status');
        try {
            const fWord = document.getElementById('wordInp').files[0];
            const fExcel = document.getElementById('excelInp').files[0];
            if(!fWord || !fExcel) return alert("B·ªì ch·ªçn thi·∫øu file r·ªìi!");

            st.innerText = "‚è≥ ƒêang x·ª≠ l√Ω d·ªØ li·ªáu s·∫°ch...";

            // 1. ƒê·ªçc v√† "r·ª≠a" d·ªØ li·ªáu Excel
            const exBuf = await fExcel.arrayBuffer();
            const workbook = XLSX.read(exBuf, {type: 'array'});
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const cleanRows = JSON.parse(JSON.stringify(rawData)); // Lo·∫°i b·ªè c√°c thu·ªôc t√≠nh l·∫° g√¢y l·ªói

            // 2. C·∫•u h√¨nh Image Module
            const imgOptions = {
                getImage: function(tagValue) { return photoVault[tagValue]; },
                getSize: function() { return [500, 350]; }
            };
            const ImgModule = window.ImageModule || window.DocxtemplaterImageModuleV2;
            const imgInstance = new ImgModule(imgOptions);

            // 3. X·ª≠ l√Ω file Word (Quy tr√¨nh chu·∫©n n√© l·ªói Namespace)
            const wordBuf = await fWord.arrayBuffer();
            const zip = new window.PizZip(wordBuf);
            
            // Kh·ªüi t·∫°o docxtemplater theo c√°ch an to√†n nh·∫•t cho b·∫£n 3.21.0
            const doc = new window.docxtemplater();
            doc.loadZip(zip);
            doc.attachModule(imgInstance); // G·∫Øn module ·∫£nh ri√™ng bi·ªát
            
            doc.setData({ rows: cleanRows });
            
            // Ch·∫°y render
            doc.render();

            // 4. Xu·∫•t file
            const out = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            });
            
            saveAs(out, "Bao_Cao_Da_Fix_Loi.docx");
            st.innerHTML = "<span style='color:green'>‚úÖ Th√†nh c√¥ng r·ª±c r·ª°!</span>";

        } catch (e) {
            console.error(e);
            st.innerHTML = "<span style='color:red'>‚ùå L·ªói: " + e.message + "</span>";
            alert("V·∫´n l·ªói b·ªì ∆°i: " + e.message);
        }
    }
</script>
</body>
</html>
