<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B·∫£n Fix Tri·ªát ƒê·ªÉ - Hi·ªán Ch·ªØ & H√¨nh</title>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.21.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; text-align: center; }
        .box { background: white; padding: 30px; border-radius: 15px; display: inline-block; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { display: block; margin-bottom: 15px; width: 100%; }
        button { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="box">
    <h3>üìÇ Fix l·ªói tr·∫Øng file & Multi-error</h3>
    <label>1. File Word m·∫´u:</label>
    <input type="file" id="w">
    <label>2. File Excel:</label>
    <input type="file" id="x">
    <label>3. Ch·ªçn ·∫£nh:</label>
    <input type="file" id="i" multiple>
    <button onclick="run()">üöÄ XU·∫§T FILE NGAY</button>
    <p id="msg" style="font-weight: bold; color: blue;"></p>
</div>

<script>
    let imgs = {};
    document.getElementById('i').onchange = (e) => {
        Array.from(e.target.files).forEach(f => {
            const r = new FileReader();
            r.onload = (ev) => { imgs[f.name] = ev.target.result; };
            r.readAsArrayBuffer(f);
        });
    };

    async function run() {
        const msg = document.getElementById('msg');
        try {
            const fW = document.getElementById('w').files[0];
            const fX = document.getElementById('x').files[0];
            if(!fW || !fX) return alert("Ch·ªçn ƒë·ªß file b·ªì ∆°i!");

            msg.innerText = "‚è≥ ƒêang ki·ªÉm tra d·ªØ li·ªáu...";
            const xB = await fX.arrayBuffer();
            const sheet = XLSX.read(xB).Sheets[XLSX.read(xB).SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(sheet);

            // X·ª¨ L√ù D·ªÆ LI·ªÜU C·ª∞C K·ª≤ C·∫®N TH·∫¨N
            const cleanData = data.map(item => {
                let newItem = {};
                for (let key in item) {
                    // Lo·∫°i b·ªè c√°c k√Ω t·ª± l·∫° trong t√™n c·ªôt Excel
                    let cleanKey = key.trim().replace(/%/g, ''); 
                    newItem[cleanKey] = item[key];
                }
                return newItem;
            });

            const zip = new window.PizZip(await fW.arrayBuffer());
            const doc = new window.docxtemplater();
            doc.loadZip(zip);

            // C·∫§U H√åNH IMAGE MODULE AN TO√ÄN
            const imgMod = new window.ImageModule({
                getImage: (name) => imgs[name] || null,
                getSize: () => [300, 200]
            });
            doc.attachModule(imgMod);

            // √âP KI·ªÇU D·ªÆ LI·ªÜU PH·∫≤NG
            doc.setData({ rows: cleanData });

            msg.innerText = "‚è≥ ƒêang render (V∆∞·ª£t l·ªói XML)...";
            doc.render();

            const out = doc.getZip().generate({type: "blob"});
            saveAs(out, "Ket_Qua_Chuan.docx");
            msg.innerText = "‚úÖ ƒê√É XU·∫§T FILE! M·ªü xem c√≥ ch·ªØ ch∆∞a b·ªì?";

        } catch (e) {
            console.error(e);
            msg.innerText = "‚ùå L·ªói: " + (e.properties?.errors?.[0]?.properties?.explanation || e.message);
        }
    }
</script>
</body>
</html>
