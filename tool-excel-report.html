<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o C√°o Kh·∫£o S√°t T·ªïng H·ª£p</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.0/build/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; background: #f4f4f9; }
        .box { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        .btn { width: 100%; padding: 10px; background: #2563eb; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #log { margin-top: 15px; font-size: 0.9em; color: #555; }
    </style>
</head>
<body>

<div class="box">
    <h2>üöÄ B√°o C√°o Kh·∫£o S√°t T·ª± ƒê·ªông</h2>
    
    <div class="input-group">
        <label>1. M·∫´u Word ({#rows}...{%ANH}...{/rows})</label><br>
        <input type="file" id="tpl" accept=".docx">
    </div>

    <div class="input-group">
        <label>2. File Excel d·ªØ li·ªáu</label><br>
        <input type="file" id="data" accept=".xlsx">
    </div>

    <div class="input-group">
        <label>3. Ch·ªçn t·∫•t c·∫£ ·∫£nh kh·∫£o s√°t</label><br>
        <input type="file" id="imgs" multiple accept="image/*">
    </div>

    <button class="btn" onclick="generate()">T·∫†O FILE WORD T·ªîNG H·ª¢P</button>
    <div id="log"></div>
</div>

<script>
    let photoLibrary = {}; // N∆°i l∆∞u tr·ªØ ·∫£nh t·∫°m th·ªùi

    // ƒê·ªçc ·∫£nh v√†o b·ªô nh·ªõ khi ng∆∞·ªùi d√πng ch·ªçn
    document.getElementById('imgs').onchange = function(e) {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                photoLibrary[file.name] = event.target.result; // L∆∞u theo t√™n file
            };
            reader.readAsArrayBuffer(file);
        });
    };

    async function generate() {
        const log = document.getElementById('log');
        const tplFile = document.getElementById('tpl').files[0];
        const dataFile = document.getElementById('data').files[0];

        if(!tplFile || !dataFile) return alert("Thi·∫øu file k√¨a b·ªì ∆°i!");

        log.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";

        try {
            // 1. ƒê·ªçc Excel
            const exBuf = await dataFile.arrayBuffer();
            const wb = XLSX.read(exBuf);
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

            // 2. C·∫•u h√¨nh Image Module
            const imageOptions = {
                getImage: (tagValue) => photoLibrary[tagValue], // T√¨m ·∫£nh theo t√™n file ghi trong Excel
                getSize: () => [400, 250] // K√≠ch th∆∞·ªõc ·∫£nh trong Word
            };
            const imgMod = new window.DocxtemplaterImageModuleV2(imageOptions);

            // 3. ƒê·ªçc Word Template
            const zip = new PizZip(await tplFile.arrayBuffer());
            const doc = new docxtemplater(zip, { 
                modules: [imgMod], 
                paragraphLoop: true, 
                linebreaks: true 
            });

            // 4. Render (Excel row l·∫∑p l·∫°i trong {rows})
            doc.render({ rows: rows });

            // 5. Xu·∫•t file
            const out = doc.getZip().generate({type:"blob"});
            saveAs(out, "Bao_Cao_Hoan_Thien.docx");
            log.innerText = "‚úÖ Th√†nh c√¥ng r·ª±c r·ª°!";

        } catch (e) {
            log.innerText = "‚ùå L·ªói r·ªìi: " + e.message;
            console.error(e);
        }
    }
</script>
</body>
</html>
