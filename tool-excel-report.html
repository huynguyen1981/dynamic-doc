<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,">
    <title>Excel to Word - Final Stable</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.21.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); display: flex; justify-content: center; padding-top: 50px; }
        .box { width: 100%; max-width: 480px; background: white; padding: 35px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #1e293b; margin-bottom: 25px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 8px; }
        input[type="file"] { width: 100%; margin-bottom: 20px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 1rem; }
        #status { margin-top: 20px; text-align: center; font-weight: 600; font-size: 0.9rem; color: #475569; }
    </style>
</head>
<body>

<div class="box">
    <h2>üìä B√°o C√°o T·ª± ƒê·ªông</h2>
    
    <label>1. File Word m·∫´u (Ch·ª©a th·∫ª {%HINH_ANH})</label>
    <input type="file" id="wordInp" accept=".docx">

    <label>2. File Excel (C·ªôt HINH_ANH)</label>
    <input type="file" id="excelInp" accept=".xlsx">

    <label>3. Ch·ªçn t·∫•t c·∫£ ·∫£nh kh·∫£o s√°t</label>
    <input type="file" id="imgInp" multiple accept="image/*">

    <button class="btn" onclick="generate()">üöÄ XU·∫§T B√ÅO C√ÅO NGAY</button>
    <div id="status">S·∫µn s√†ng!</div>
</div>

<script>
    let photoVault = {};

    // N·∫°p ·∫£nh v√†o b·ªô nh·ªõ ngay khi ch·ªçn
    document.getElementById('imgInp').onchange = (e) => {
        photoVault = {};
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => { photoVault[file.name] = ev.target.result; };
            reader.readAsArrayBuffer(file);
        });
    };

    async function generate() {
        const status = document.getElementById('status');
        try {
            const fWord = document.getElementById('wordInp').files[0];
            const fExcel = document.getElementById('excelInp').files[0];
            if(!fWord || !fExcel) return alert("B·ªì ch·ªçn thi·∫øu file r·ªìi k√¨a!");

            status.innerText = "‚è≥ ƒêang render file...";

            // 1. ƒê·ªçc Excel
            const exBuf = await fExcel.arrayBuffer();
            const workbook = XLSX.read(exBuf, {type: 'array'});
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const rows = JSON.parse(JSON.stringify(rawData)); // "R·ª≠a" s·∫°ch d·ªØ li·ªáu

            // 2. C·∫•u h√¨nh Image Module
            const imgOptions = {
                getImage: function(tagValue) { return photoVault[tagValue]; },
                getSize: function() { return [500, 350]; }
            };
            const ImgModuleCtor = window.ImageModule || window.DocxtemplaterImageModuleV2;
            const imgInstance = new ImgModuleCtor(imgOptions);

            // 3. X·ª≠ l√Ω file Word (C√°ch n·∫°p chu·∫©n cho b·∫£n 3.21.0)
            const wordBuf = await fWord.arrayBuffer();
            
            // ·ªû b·∫£n 3.1.4, PizZip n·∫°p v√†o window.PizZip
            const zip = new window.PizZip(wordBuf);
            
            // ·ªû b·∫£n 3.21.0, kh·ªüi t·∫°o v√† n·∫°p module theo c√°ch n√†y:
            const doc = new window.docxtemplater();
            doc.loadZip(zip);
            doc.attachModule(imgInstance);
            
            doc.setData({ rows: rows });
            
            // Ch·∫°y render
            doc.render();

            // 4. Xu·∫•t file
            const out = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            });
            
            saveAs(out, "Bao_Cao_Hoan_Thien.docx");
            status.innerHTML = "<span style='color:green'>‚úÖ Xu·∫•t file th√†nh c√¥ng r·ª±c r·ª°!</span>";

        } catch (e) {
            console.error(e);
            status.innerHTML = "<span style='color:red'>‚ùå L·ªói: " + e.message + "</span>";
            alert("L·ªói: " + e.message);
        }
    }
</script>
</body>
</html>
