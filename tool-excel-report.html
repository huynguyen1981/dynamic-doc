<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,">
    <title>Excel to Word - Stable Version</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/imagemodule.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { width: 100%; max-width: 500px; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .btn { width: 100%; padding: 15px; background: #94a3b8; color: white; border: none; border-radius: 10px; font-weight: 700; cursor: not-allowed; transition: 0.3s; margin-top: 15px; }
        #status { margin-top: 20px; text-align: center; font-size: 0.85rem; font-weight: 600; padding: 10px; border-radius: 8px; }
        .loading { background: #fff7ed; color: #c2410c; }
        .ready { background: #f0fdf4; color: #15803d; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align: center; margin-bottom: 25px;">üìä B√°o C√°o Kh·∫£o S√°t T·ª± ƒê·ªông</h2>
    
    <div style="margin-bottom:15px">
        <label style="display:block; font-size:0.8rem; font-weight:700; color:#64748b; margin-bottom:5px">1. FILE M·∫™U WORD</label>
        <input type="file" id="wordFile" accept=".docx" style="width:100%">
    </div>

    <div style="margin-bottom:15px">
        <label style="display:block; font-size:0.8rem; font-weight:700; color:#64748b; margin-bottom:5px">2. FILE EXCEL D·ªÆ LI·ªÜU</label>
        <input type="file" id="xlsxFile" accept=".xlsx" style="width:100%">
    </div>

    <div style="margin-bottom:15px">
        <label style="display:block; font-size:0.8rem; font-weight:700; color:#64748b; margin-bottom:5px">3. CH·ªåN T·∫§T C·∫¢ ·∫¢NH</label>
        <input type="file" id="imgFiles" multiple accept="image/*" style="width:100%">
    </div>

    <button class="btn" id="mainBtn" disabled onclick="process()">ƒêANG KI·ªÇM TRA TH∆Ø VI·ªÜN...</button>
    <div id="status" class="loading">‚è≥ Ch·ªù n·∫°p t√†i nguy√™n...</div>
</div>

<script>
    let photoLib = {};
    const btn = document.getElementById('mainBtn');
    const status = document.getElementById('status');

    // Ki·ªÉm tra xem ImageModule n·∫°p v√†o bi·∫øn n√†o
    const checkTimer = setInterval(() => {
        const isDocxReady = window.docxtemplater || window.Docxtemplater;
        const isImgReady = window.ImageModule || window.DocxtemplaterImageModuleV2;

        if (window.PizZip && isDocxReady && window.XLSX && isImgReady) {
            clearInterval(checkTimer);
            btn.disabled = false;
            btn.style.background = "var(--p)";
            btn.style.cursor = "pointer";
            btn.innerText = "üöÄ XU·∫§T FILE T·ªîNG H·ª¢P";
            status.innerText = "‚úÖ Th∆∞ vi·ªán b·ªì ch·ªçn ƒë√£ S·∫¥N S√ÄNG!";
            status.className = "ready";
        }
    }, 500);

    document.getElementById('imgFiles').onchange = (e) => {
        photoLib = {};
        Array.from(e.target.files).forEach(file => {
            const r = new FileReader();
            r.onload = (ev) => { photoLib[file.name] = ev.target.result; };
            r.readAsArrayBuffer(file);
        });
    };

    async function process() {
        const wordFile = document.getElementById('wordFile').files[0];
        const xlsxFile = document.getElementById('xlsxFile').files[0];

        if(!wordFile || !xlsxFile) return alert("B·ªì ch·ªçn thi·∫øu file r·ªìi!");

        try {
            status.innerText = "‚è≥ ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...";
            const wordBuf = await wordFile.arrayBuffer();
            const xlsxBuf = await xlsxFile.arrayBuffer();
            
            const workbook = XLSX.read(xlsxBuf, {type: 'array'});
            const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

            const ImgModuleCtor = window.ImageModule || window.DocxtemplaterImageModuleV2;
            const imgOpts = {
                getImage: (tagValue) => photoLib[tagValue],
                getSize: () => [450, 300] // K√≠ch th∆∞·ªõc ·∫£nh m·∫∑c ƒë·ªãnh
            };

            const zip = new PizZip(wordBuf);
            const DocxTemplate = window.docxtemplater || window.Docxtemplater;
            const doc = new DocxTemplate(zip, {
                modules: [new ImgModuleCtor(imgOpts)],
                paragraphLoop: true,
                linebreaks: true
            });

            doc.render({ rows: data });
            
            saveAs(doc.getZip().generate({type: "blob"}), "Ket_Qua_Bao_Cao.docx");
            status.innerText = "‚úÖ Xu·∫•t b√°o c√°o th√†nh c√¥ng!";
        } catch (err) {
            console.error(err);
            alert("L·ªói render: " + err.message);
            status.innerText = "‚ùå L·ªói h·ªá th·ªëng.";
        }
    }
</script>
</body>
</html>
