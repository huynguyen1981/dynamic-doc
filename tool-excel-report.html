<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Excel to Word Report - Fast Load</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater-image-module-free@1.1.1/build/bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { width: 100%; max-width: 500px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #1e293b; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; color: #64748b; }
        input[type="file"] { width: 100%; padding: 10px; border: 2px dashed #e2e8f0; border-radius: 12px; cursor: pointer; }
        .btn { width: 100%; padding: 15px; background: #cbd5e1; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: not-allowed; transition: 0.3s; }
        #status { margin-top: 20px; text-align: center; font-size: 0.85rem; font-weight: 600; }
        .loading { color: #f59e0b; }
        .ready { color: #10b981; }
    </style>
</head>
<body>

<div class="box">
    <h2>üìä Excel to Word</h2>
    
    <div class="input-group">
        <label>1. File Word m·∫´u</label>
        <input type="file" id="tpl" accept=".docx">
    </div>

    <div class="input-group">
        <label>2. File Excel d·ªØ li·ªáu</label>
        <input type="file" id="data" accept=".xlsx">
    </div>

    <div class="input-group">
        <label>3. Ch·ªçn t·∫•t c·∫£ ·∫£nh</label>
        <input type="file" id="imgs" multiple accept="image/*">
    </div>

    <button class="btn" id="mainBtn" onclick="generate()">ƒêANG T·∫¢I TH∆Ø VI·ªÜN...</button>
    <div id="status" class="loading">ƒêang k·∫øt n·ªëi m√°y ch·ªß th∆∞ vi·ªán...</div>
</div>

<script>
    let photoLibrary = {};
    const btn = document.getElementById('mainBtn');
    const status = document.getElementById('status');

    // Ki·ªÉm tra th∆∞ vi·ªán v·ªõi t·ªëc ƒë·ªô cao (100ms)
    const checkTimer = setInterval(() => {
        // Ki·ªÉm tra t·∫•t c·∫£ c√°c bi·∫øn to√†n c·ª•c c·∫ßn thi·∫øt
        const isReady = window.PizZip && window.docxtemplater && window.XLSX && window.DocxtemplaterImageModuleV2;
        
        if (isReady) {
            clearInterval(checkTimer);
            btn.disabled = false;
            btn.style.background = "var(--p)";
            btn.style.cursor = "pointer";
            btn.innerText = "üöÄ T·∫†O B√ÅO C√ÅO NGAY";
            status.innerText = "‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!";
            status.className = "ready";
        }
    }, 100);

    document.getElementById('imgs').onchange = function(e) {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => { photoLibrary[file.name] = ev.target.result; };
            reader.readAsArrayBuffer(file);
        });
    };

    async function generate() {
        const tplFile = document.getElementById('tpl').files[0];
        const dataFile = document.getElementById('data').files[0];
        if(!tplFile || !dataFile) return alert("Ch·ªçn file ƒëi b·ªì!");

        try {
            status.innerText = "‚è≥ ƒêang x·ª≠ l√Ω... (Vui l√≤ng kh√¥ng ƒë√≥ng trang)";
            
            const exBuf = await dataFile.arrayBuffer();
            const rows = XLSX.utils.sheet_to_json(XLSX.read(exBuf).Sheets[XLSX.read(exBuf).SheetNames[0]]);

            const imgOptions = {
                getImage: (name) => photoLibrary[name],
                getSize: () => [450, 300]
            };
            
            // D√πng tr·ª±c ti·∫øp ƒë·ªëi t∆∞·ª£ng t·ª´ window ƒë·ªÉ tr√°nh l·ªói constructor
            const imgMod = new window.DocxtemplaterImageModuleV2(imgOptions);
            const zip = new PizZip(await tplFile.arrayBuffer());
            const doc = new window.docxtemplater(zip, { modules: [imgMod], paragraphLoop: true, linebreaks: true });

            doc.render({ rows: rows });
            saveAs(doc.getZip().generate({type:"blob"}), "Bao_Cao_Tong_Hop.docx");
            status.innerText = "‚úÖ Ho√†n th√†nh!";
        } catch (e) {
            alert("L·ªói: " + e.message);
            status.innerText = "‚ùå G·∫∑p l·ªói khi x·ª≠ l√Ω.";
        }
    }
</script>
</body>
</html>
